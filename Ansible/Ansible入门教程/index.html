<!DOCTYPE HTML>
<html lang="null">
<head><meta name="generator" content="Hexo 3.8.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="Cloud Service一站通">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://blog.ozairs.com">
    <!--SEO-->

    <meta name="keywords" content="Ansible">


    <meta name="description" content="
关于Ansible的一个好处是，将bash脚本转换为可执行任务是非常容易的。我们可以编写自己的配置程序，但是Ansible更加干净，因为它可以自动在执行任务之前获取上下文。ansible任务是...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>Ansible入门教程 | Cloud Service一站通</title>


    <link rel="alternate" href="/atom.xml" title="Cloud Service一站通" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>





	<script>
		(function(i, s, o, g, r, a, m) {
		    i['GoogleAnalyticsObject'] = r;
		    i[r] = i[r] || function() {
		        (i[r].q = i[r].q || []).push(arguments)
		    }, i[r].l = 1 * new Date();
		    a = s.createElement(o),
		    m = s.getElementsByTagName(o)[0];
		    a.async = 1;
		    a.src = g;
		    m.parentNode.insertBefore(a, m)
		})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
		ga('create', 'UA-136105852-1', 'auto');
		ga('send', 'pageview');
	</script>


    

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header">
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="Mark Wu">
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                 <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://blog.ozairs.com">Cloud Service一站通</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>Main</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/AWS"><i class="fa "></i>AWS</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Ansible"><i class="fa "></i>Ansible</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Cloud-Service"><i class="fa "></i>Cloud Service</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Security"><i class="fa "></i>Security</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/DevOps"><i class="fa "></i>DevOps</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Docker"><i class="fa "></i>Docker</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Jenkins"><i class="fa "></i>Jenkins</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Kubernetes"><i class="fa "></i>Kubernetes</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Python"><i class="fa "></i>Python</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Terraform"><i class="fa "></i>Terraform</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>Archives</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="https://156709406.gitbook.io/markwu100/"><i class="fa "></i>《Go Terraform》Chinese Version</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Ansible入门教程">
            
	            Ansible入门教程
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/Ansible/">Ansible</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/Ansible/">Ansible</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/03/12</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>377</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p><img src="/Ansible/Ansible入门教程/1.png" alt=""></p>
<p>关于Ansible的一个好处是，将bash脚本转换为可执行任务是非常容易的。我们可以编写自己的配置程序，但是Ansible更加干净，因为它可以自动在执行任务之前获取上下文。ansible任务是幂等的，没有大量额外的编码，ansible可以一次又一次地安全运，而bash命令这种幂等性。 </p>
<iframe allowtransparency="true" title="Wistia video player" allowfullscreen frameborder="0" scrolling="no" class="wistia_embed" name="wistia_embed" src="https://fast.wistia.net/embed/iframe/qrqfj371b6" width="400" height="225"></iframe>

<p>Ansible使用“facts”来确保任务的幂等安全运行， 它是在运行任务之前收集的系统和环境信息。ansible使用这些facts来检查状态，看看是否需要改变某些东西以获得所需的结果。这使得ansible可以让服务器一次又一次地运行可复制的任务。</p>
<h1 id="1-安装"><a href="#1-安装" class="headerlink" title="1 安装"></a>1 安装</h1><p>当然我们需要先安装Ansible。任务可以从任何可安装的机器上运行。</p>
<h3 id="1-1-Ubuntu"><a href="#1-1-Ubuntu" class="headerlink" title="1.1 Ubuntu"></a>1.1 Ubuntu</h3><p>在Ubuntu 16.04上安装Ansible的方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y ansible1</span><br></pre></td></tr></table></figure>
<p>apt-get安装的ansible版本很低，建议使用pip方式安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install ansible1</span><br></pre></td></tr></table></figure>
<h1 id="2-配置"><a href="#2-配置" class="headerlink" title="2 配置"></a>2 配置</h1><p>ansible的默认配置文件路径为 /etc/ansible，然而，一个常见的用途是将其安装在一个virtualenv中，在这种情况下，我们一般不会使用这些默认文件。我们可以根据需要在本地目录中创建配置文件。</p>
<h2 id="2-1-管理服务器：Inventory文件"><a href="#2-1-管理服务器：Inventory文件" class="headerlink" title="2.1 管理服务器：Inventory文件"></a>2.1 管理服务器：Inventory文件</h2><p>您可以创建一个inventory文件，用于定义将要管理的服务器。这个文件可以命名为任何名字，但我们通常会命名为hosts或者项目的名称。<br>在hosts文件中，我们可以定义一些要管理的服务器。这里我们将定义我们可能要在“web”标签下管理的两个服务器。标签是任意的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[web]</span><br><span class="line">192.168.22.10</span><br><span class="line">192.168.22.11123</span><br></pre></td></tr></table></figure>
<p>现在已经够好了，如果需要，我们可以定义主机范围，多个组，可重用变量，并使用其他花哨的设置，包括创建动态的inventory。<br>当我们在本地机器运行ansible时，我们不需要关心inventory文件中的内容，我将告诉您在本地和远程服务器上运行ansible。现在，让我们将hosts文件设置为指向本地主机local和remote虚拟远程主机。<br>hosts文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[local]</span><br><span class="line">127.0.0.1</span><br><span class="line"></span><br><span class="line">[remote]</span><br><span class="line">192.168.1.212345</span><br></pre></td></tr></table></figure>
<p>与本地主机和远程服务器连接的命令。</p>
<h2 id="2-2-基础：运行命令"><a href="#2-2-基础：运行命令" class="headerlink" title="2.2 基础：运行命令"></a>2.2 基础：运行命令</h2><p>我们开始对服务器运行任务。ansible会假定你的服务器具有SSH访问权限，通常基于SSH-Key。因为Ansible使用SSH，所以它需要能够SSH连接到服务器。但是，ansible将尝试以正在运行的当前用户身份进行连接。如果我正在运行ansible的用户是ubuntu，它将尝试以ubuntu连接其他服务器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Run against localhost</span><br><span class="line">$ ansible -i ./hosts --connection=local local -m ping</span><br><span class="line"></span><br><span class="line"># Run against remote server</span><br><span class="line">$ ansible -i ./hosts remote -m ping</span><br><span class="line">127.0.0.1 | success &gt;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;123456789</span><br></pre></td></tr></table></figure>
<p>如果你是在cygwin下运行，遇到了“Failed to connect to the host via ssh: mux_client_request_session: read from master failed”的错误，可以执行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i ./hosts remote -v -m ping -u root --private-key=~/.ssh/id_rsa1</span><br></pre></td></tr></table></figure>
<p>使用–connection=local告诉ansible不尝试通过SSH运行命令，因为我们只是影响本地主机。但是，我们仍然需要一个hosts文件，告诉我们连接到哪里。<br>在任何情况下，我们可以看到从ansible得到的输出是一些JSON，它告诉我们Task（我们对ping模块的调用）是否进行了任何更改和结果。</p>
<p>命令说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-i ./hosts - 设置库存文件，命名为 hosts</span><br><span class="line">remote，local，all-使用这个标签的下定义的服务器hosts清单文件。“all”是针对文件中定义的每个服务器运行的特殊关键字</span><br><span class="line">-m ping- 使用“ping”模块，它只是运行ping命令并返回结果</span><br><span class="line">-c local| --connection=local - 在本地服务器上运行命令，而不是SSH</span><br><span class="line"></span><br><span class="line">一些常用命令：</span><br><span class="line">-i PATH --inventory=PATH 指定host文件的路径，默认是在/etc/ansible/hosts</span><br><span class="line">--private-key=PRIVATE_KEY_FILE_PATH 使用指定路径的秘钥建立认证连接</span><br><span class="line">-m DIRECTORY --module-path=DIRECTORY 指定module的目录来加载module，默认是/usr/share/ansible</span><br><span class="line">-c CONNECTION --connection=CONNECTION 指定建立连接的类型，一般有ssh ，local12345678910</span><br></pre></td></tr></table></figure>
<h3 id="2-2-1-模块（Modules）"><a href="#2-2-1-模块（Modules）" class="headerlink" title="2.2.1 模块（Modules）"></a>2.2.1 模块（Modules）</h3><p>ansible使用“模块”来完成大部分的任务。模块可以做安装软件，复制文件，使用模板等等。</p>
<h4 id="模块是使用Ansible-的方法"><a href="#模块是使用Ansible-的方法" class="headerlink" title="模块是使用Ansible 的方法"></a>模块是使用Ansible 的方法</h4><p>因为它们可以使用可用的上下文（“Facts”），以便确定要完成任务需要做什么操作。<br>如果我们没有模块，我们将运行任意的shell命令，我们也可以使用bash脚本。这是一个任意shell命令看起来像在Ansible（它使用的shell模块！）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Run against a local server</span><br><span class="line">ansible -i ./hosts local --connection=local -b --become-user=root \</span><br><span class="line">    -m shell -a &apos;apt-get install nginx&apos;</span><br><span class="line"></span><br><span class="line"># Run against a remote server</span><br><span class="line">ansible -i ./hosts remote -b --become-user=root all \</span><br><span class="line">    -m shell -a &apos;apt-get install nginx&apos;1234567</span><br></pre></td></tr></table></figure>
<p>这里，sudo apt-get install nginx命令将使用“shell”模块运行。<br>命令说明:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-b - “成为”，在运行命令时告诉可以成为另一个用户。</span><br><span class="line">--become-user=root - 以用户“root”运行以下命令（例如，使用命令使用“sudo”）。我们可以在此定义任何现有的用户。</span><br><span class="line">-a 用于将任何参数传递给定义的模块 -m123</span><br></pre></td></tr></table></figure>
<p>但是这并不是特别强大。尽管能够一次在所有服务器上运行这些命令，但是我们仍然只能完成任何bash脚本可能执行的操作。如果我们使用了更合适的模块，我们可以运行命令来保证结果。可靠的模块确保我们可以一次又一次地运行相同的任务，而不会影响最终结果。<br>要在Debian / Ubuntu服务器上安装软件，“apt”模块将运行相同的命令，但确保幂等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># Run against a local server</span><br><span class="line">ansible -i ./hosts local --connection=local -b --become-user=root \</span><br><span class="line">    -m apt -a &apos;name=nginx state=installed update_cache=true&apos;</span><br><span class="line"></span><br><span class="line">127.0.0.1 | success &gt;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Run against a remote server</span><br><span class="line">ansible -i ./hosts remote -b --become-user=root \</span><br><span class="line">    -m apt -a &apos;name=nginx state=installed update_cache=true&apos;</span><br><span class="line"></span><br><span class="line">127.0.0.1 | success &gt;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">or：</span><br><span class="line">ansible -i ./hosts remote -v -m apt -a &apos;name=nginx state=installed update_cache=true&apos; -u test -s -K --private-key=~/.ssh/id_rsa</span><br><span class="line">12345678910111213141516171819</span><br></pre></td></tr></table></figure>
<p>这将使用apt模块来更新存储库缓存并安装Nginx（如果没有安装）。<br>运行任务的结果是”changed”: false。这表明没有变化; 我已经使用该shell模块安装了Nginx 。好的是，我可以一遍又一遍地运行这个命令，而不用担心它会改变预期的结果 - Nginx已经安装，Ansible知道，并且不尝试重新安装它。<br>命令说明:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-i ./hosts - 设置inventory文件，命名为 hosts</span><br><span class="line">-b - “成”，告诉可以成为另一个用户来运行命令</span><br><span class="line">--become-user=root - 以用户“root”运行以下命令（例如，使用“sudo”命令）</span><br><span class="line">local| remote - 从库存文件中的本地或远程定义的主机上运行</span><br><span class="line">-m apt- 使用apt模块</span><br><span class="line">-a &apos;name=nginx state=installed update_cache=true&apos; - 提供apt模块的参数，包括软件包名称，所需的结束状态以及是否更新软件包存储库缓存</span><br><span class="line"></span><br><span class="line">常用命令：</span><br><span class="line">-u USERNAME --user=USERNAME 指定移动端的执行用户</span><br><span class="line">-U SUDO_USERNAME --sudo-user=USERNAME</span><br><span class="line">-s --sudo -u指定用户的时候，使用sudo获得root权限</span><br><span class="line">-k --ask-pass  提示输入ssh的密码，而不是使用基于ssh的密钥认证</span><br><span class="line">-K --ask-sudo-pass 提示输入sudo密码，与--sudo一起使用12345678910111213</span><br></pre></td></tr></table></figure>
<p>我们可以通过这种特殊方式运行我们所需要的所有任务（通过模块），但是让我们来做这个更具管理性。我们将把这个任务移动到一个Playbook中，它可以运行和协调多个Tasks。</p>
<h2 id="2-3-剧本（Playbooks）"><a href="#2-3-剧本（Playbooks）" class="headerlink" title="2.3 剧本（Playbooks）"></a>2.3 剧本（Playbooks）</h2><p>Playbook可以运行多个任务，并提供一些更高级的功能。让我们将上述任务移到一本剧本中。在ansible中剧本（playbooks）和角色（roles）都使用Yaml文件定义。<br>创建文件nginx.yml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"># hosts could have been &quot;remote&quot; or &quot;all&quot; as well</span><br><span class="line">- hosts: local</span><br><span class="line">  connection: local</span><br><span class="line">  become: yes</span><br><span class="line">  become_user: root</span><br><span class="line">  tasks:</span><br><span class="line">   - name: Install Nginx</span><br><span class="line">     apt:</span><br><span class="line">       name: nginx</span><br><span class="line">       state: installed</span><br><span class="line">       update_cache: true123456789101112</span><br></pre></td></tr></table></figure>
<p>此任务与我们的ad-hoc命令完全相同，包括设置本地连接的使用。<br>这将使用inventory文件中[local]标签下的服务器hosts。<br>如果我们没有使用本地连接，我们会这样做：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: remote</span><br><span class="line">  become: yes</span><br><span class="line">  become_user: root</span><br><span class="line">  tasks:</span><br><span class="line">   - name: Install Nginx</span><br><span class="line">     apt:</span><br><span class="line">       name: nginx</span><br><span class="line">       state: installed</span><br><span class="line">       update_cache: true12345678910</span><br></pre></td></tr></table></figure>
<p>这将使用inventory文件中[remote]标签下的服务器hosts。</p>
<p>在我们的Tasks文件中使用become并become_user再次使用Ansible来sudo以root用户身份运行命令，然后传递Playbook文件。</p>
<p>使用一个yaml playbook文件，我们需要使用这个ansible-playbook命令，现在就更容易运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i ./hosts nginx.yml</span><br><span class="line"></span><br><span class="line">PLAY [local] ******************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [Install Nginx] *********************************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">127.0.0.1                  : ok=2    changed=0    unreachable=0    failed=0123456789101112</span><br></pre></td></tr></table></figure>
<p>我们在运行过程中获得了一些有用的反馈，包括“可执行任务”运行及其结果。在这里我们看到所有运行都OK，但没有改变。我已经安装了Nginx</p>
<h3 id="2-3-1-处理程序（Handlers）"><a href="#2-3-1-处理程序（Handlers）" class="headerlink" title="2.3.1 处理程序（Handlers）"></a>2.3.1 处理程序（Handlers）</h3><p>处理程序与任务完全相同（它可以做task可以做的任何事），但只有当另一个任务调用它时才会运行。您可以将其视为事件系统的一部分; 处理程序将通过其侦听的事件调用进行操作。<br>这对于运行任务后可能需要的“辅助”操作非常有用，例如在配置更改后安装或重新加载服务后启动新服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"># Example shows using the local machine still</span><br><span class="line"># Remove &apos;connection&apos; and set hosts to &apos;remote&apos; for a remote connection</span><br><span class="line">- hosts: local</span><br><span class="line">  connection: local</span><br><span class="line">  become: yes</span><br><span class="line">  become_user: root</span><br><span class="line">  tasks:</span><br><span class="line">   - name: Install Nginx</span><br><span class="line">     apt:</span><br><span class="line">       name: nginx</span><br><span class="line">       state: installed</span><br><span class="line">       update_cache: true</span><br><span class="line">     notify:</span><br><span class="line">      - Start Nginx</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">   - name: Start Nginx</span><br><span class="line">     service:</span><br><span class="line">       name: nginx</span><br><span class="line">       state: started123456789101112131415161718192021</span><br></pre></td></tr></table></figure>
<p>这里我们添加一个notify指令到安装任务。这将在任务运行后通知名为“Start Nginx”的处理程序。</p>
<p>然后我们可以创建名为“Start Nginx”的处理程序。此处理程序是通知“Start Nginx”时调用的任务。<br>这个特定的处理程序使用服务模块，它可以启动，停止，重启，重新加载（等等）系统服务。在这种情况下，我们告诉Ansible，我们要启动Nginx。<br>让我们再次运行这本Playbook：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i ./hosts nginx.yml</span><br><span class="line"></span><br><span class="line">PLAY [local] ******************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [Install Nginx] *********************************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">NOTIFIED: [nginx | Start Nginx] ***********************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">127.0.0.1                  : ok=2    changed=0    unreachable=0    failed=0123456789101112131415</span><br></pre></td></tr></table></figure>
<p>我们得到类似的输出，但是这次Handler是运行的。<br>通知程序只在运行任务时运行。</p>
<h5 id="Note：如果我已经安装了Nginx，则安装Nginx任务将不会运行，通知程序也将不会被调用。"><a href="#Note：如果我已经安装了Nginx，则安装Nginx任务将不会运行，通知程序也将不会被调用。" class="headerlink" title="Note：如果我已经安装了Nginx，则安装Nginx任务将不会运行，通知程序也将不会被调用。"></a>Note：如果我已经安装了Nginx，则安装Nginx任务将不会运行，通知程序也将不会被调用。</h5><p>我们可以使用Playbook来运行多个任务，添加变量，定义其他设置，甚至包括其他的剧本。</p>
<h3 id="2-3-2-更多的任务（More-Tasks）"><a href="#2-3-2-更多的任务（More-Tasks）" class="headerlink" title="2.3.2 更多的任务（More Tasks）"></a>2.3.2 更多的任务（More Tasks）</h3><p>接下来，我们可以为此Playbook添加更多的任务，并探索其他一些功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"># Example shows using the local machine still</span><br><span class="line"># Remove &apos;connection&apos; and set hosts to &apos;remote&apos; for a remote connection</span><br><span class="line">- hosts: local</span><br><span class="line">  connection: local</span><br><span class="line">  become: yes</span><br><span class="line">  become_user: root</span><br><span class="line">  vars:</span><br><span class="line">   - docroot: /var/www/serversforhackers.com/public</span><br><span class="line">  tasks:</span><br><span class="line">   - name: Add Nginx Repository</span><br><span class="line">     apt_repository:</span><br><span class="line">       repo: ppa:nginx/stable</span><br><span class="line">       state: present</span><br><span class="line">     register: ppastable</span><br><span class="line"></span><br><span class="line">   - name: Install Nginx</span><br><span class="line">     apt:</span><br><span class="line">       pkg: nginx</span><br><span class="line">       state: installed</span><br><span class="line">       update_cache: true</span><br><span class="line">     when: ppastable|success</span><br><span class="line">     notify:</span><br><span class="line">      - Start Nginx</span><br><span class="line"></span><br><span class="line">   - name: Create Web Root</span><br><span class="line">     file:</span><br><span class="line">      path: &apos;&#123;&#123; docroot &#125;&#125;&apos;</span><br><span class="line">      mode: 775</span><br><span class="line">      state: directory</span><br><span class="line">      owner: www-data</span><br><span class="line">      group: www-data</span><br><span class="line">     notify:</span><br><span class="line">      - Reload Nginx</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">   - name: Start Nginx</span><br><span class="line">     service:</span><br><span class="line">       name: nginx</span><br><span class="line">       state: started</span><br><span class="line"></span><br><span class="line">    - name: Reload Nginx</span><br><span class="line">      service:</span><br><span class="line">        name: nginx</span><br><span class="line">        state: reloaded123456789101112131415161718192021222324252627282930313233343536373839404142434445</span><br></pre></td></tr></table></figure>
<p>现在有三个任务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Add Nginx Repository- 使用apt_repository模块添加Nginx稳定PPA以获取最新的稳定版本的Nginx 。</span><br><span class="line">Install Nginx - 使用Apt模块安装Nginx。</span><br><span class="line">Create Web Root - 最后创建一个Web根目录。123</span><br></pre></td></tr></table></figure>
<p>新的register和when指令，可以实现在某些事情发生后让ansible执行任务的功能。</p>
<h5 id="Note-您还可以注册模块操作的结果，并使用定义的变量根据注册（register）的变量值有条件（when）地执行操作。例如，注册通过shell模块运行命令的结果可以让您访问该命令的stdout。"><a href="#Note-您还可以注册模块操作的结果，并使用定义的变量根据注册（register）的变量值有条件（when）地执行操作。例如，注册通过shell模块运行命令的结果可以让您访问该命令的stdout。" class="headerlink" title="Note: 您还可以注册模块操作的结果，并使用定义的变量根据注册（register）的变量值有条件（when）地执行操作。例如，注册通过shell模块运行命令的结果可以让您访问该命令的stdout。"></a>Note: 您还可以注册模块操作的结果，并使用定义的变量根据注册（register）的变量值有条件（when）地执行操作。例如，注册通过shell模块运行命令的结果可以让您访问该命令的stdout。</h5><p>同时还使用了一个变量。docroot变量在定义vars部分。然后将其用作创建定义目录的文件模块的目标参数。</p>
<p>需要注意的是，path配置使用括号NaN，这是Jinja2的模板。为了使Ansible能够在括号内解析Jinja2模板变量，该行必须是单引号或双引号 - 例如，path: ‘’而不是path: 。不使用引号将导致错误。<br>这个playbook可以用通常的命令运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i ./hosts nginx.yml1</span><br></pre></td></tr></table></figure>
<p>所以，我们已经运行了一些ad-hoc命令，使用了可复制的模块，并将一些相关任务组织到一个手册中。</p>
<p>接下来，我们将通过将Playbook组织成一个角色进一步获得可靠性，这有助于我们组织相关项目，如文件和模板，同时还帮助我们组织更复杂的相关任务和操作。</p>
<h2 id="2-4-角色（roles）"><a href="#2-4-角色（roles）" class="headerlink" title="2.4 角色（roles）"></a>2.4 角色（roles）</h2><p>角色很适合组织多个相关任务并封装完成这些任务所需的数据。例如，安装Nginx可能涉及添加软件包存储库，安装软件包和设置配置。<br>此外，真实的配置通常需要额外的数据，如变量，文件，动态模板等等。这些工具可以与Playbook一起使用，但是我们可以通过将相关任务和数据组织成一个角色（role， 相关的结构）很快就能做得更好。<br>角色有一个这样的目录结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">roles</span><br><span class="line">  rolename</span><br><span class="line">   - files</span><br><span class="line">   - handlers</span><br><span class="line">   - meta</span><br><span class="line">   - templates</span><br><span class="line">   - tasks</span><br><span class="line">   - vars12345678</span><br></pre></td></tr></table></figure>
<p>在每个子目录中（eg： files，handlers等等），Ansible将自动搜索并读取叫做main.yml的yaml文件。<br>接下来我们将分解nginx.yml文件内容为不同的组件，并将每个组件放在相应的目录中，以创建一个更干净，更完整的配置工具集。</p>
<h3 id="2-4-1-创建角色（Creating-a-Role）"><a href="#2-4-1-创建角色（Creating-a-Role）" class="headerlink" title="2.4.1 创建角色（Creating a Role）"></a>2.4.1 创建角色（Creating a Role）</h3><p>我们可以使用ansible-galaxy命令来创建一个新角色。此工具可用于将角色保存到Ansible的公共注册表，但是我通常只是使用它来在本地创建role的基础目录结构。</p>
<p>我们来看看如何设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Head to our previously created directory</span><br><span class="line">cd ~/ansible-example</span><br><span class="line"></span><br><span class="line"># In case we left our virtualenv at some point </span><br><span class="line">source .venv/bin/activate</span><br><span class="line"></span><br><span class="line"># Create a roles directory</span><br><span class="line">mkdir roles</span><br><span class="line">cd roles</span><br><span class="line"></span><br><span class="line"># Bootstrap a new role named &quot;nginx&quot;</span><br><span class="line">ansible-galaxy init nginx123456789101112</span><br></pre></td></tr></table></figure>
<p>目录名称roles是一种惯例，在运行一个playbook时可以用来查找角色。该目录应该始终被命名roles，但并不强制。在roles目录中运行 ansible-galaxy init nginx 命令将创建新角色所需的目录和文件。</p>
<p>我们来看看我们新建的nginx角色的每个部分~/ansible-example/roles/nginx。</p>
<h3 id="2-4-2-文件（files）"><a href="#2-4-2-文件（files）" class="headerlink" title="2.4.2 文件（files）"></a>2.4.2 文件（files）</h3><p>首先，在files目录中，我们可以添加我们要复制到我们的服务器中的文件。对于nginx，我经常复制H5BP的Nginx组件配置。我只需从Github下载最新的信息，进行一些调整，并将它们放入files目录中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/ansible-example</span><br><span class="line"> - roles</span><br><span class="line"> - - nginx</span><br><span class="line"> - - - files</span><br><span class="line"> - - - - h5bp12345</span><br></pre></td></tr></table></figure>
<p>我们稍后会看到，H5BP配置文件将通过复制模块添加到服务器。</p>
<h3 id="2-4-3-处理程序（handlers）"><a href="#2-4-3-处理程序（handlers）" class="headerlink" title="2.4.3 处理程序（handlers）"></a>2.4.3 处理程序（handlers）</h3><p>我们可以把曾经在nginx.yml 剧本中的定义的所有处理程序放入到handlers目录中。约定必须包含main.yml文件。</p>
<p>handlers/main.yml 内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: Start Nginx</span><br><span class="line">  service:</span><br><span class="line">    name: nginx</span><br><span class="line">    state: started</span><br><span class="line"></span><br><span class="line">- name: Reload Nginx</span><br><span class="line">  service:</span><br><span class="line">    name: nginx</span><br><span class="line">    state: reloaded12345678910</span><br></pre></td></tr></table></figure>
<p>一旦handlers/main.yml中的处理程序定义好了，我们可以自由地从其他的yaml配置中引用它们。</p>
<h3 id="2-4-4-元（meta）"><a href="#2-4-4-元（meta）" class="headerlink" title="2.4.4 元（meta）"></a>2.4.4 元（meta）</h3><p>meta目录中的main.yml文件包含Role元数据，包含的依赖关系。如果这个角色依赖于另一个角色，我们可以在这里定义。例如，nginx角色取决于安装SSL证书的ssl角色。约定必须包含main.yml文件。<br>meta/main.yml 内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">dependencies:</span><br><span class="line">  - &#123; role: ssl &#125;123</span><br></pre></td></tr></table></figure>
<p>如果我调用了“nginx”角色，它将尝试首先运行“ssl”角色。<br>否则我们可以省略此文件，或将角色定义为没有依赖关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">dependencies: []12</span><br></pre></td></tr></table></figure>
<h3 id="2-4-5-模板（templates）"><a href="#2-4-5-模板（templates）" class="headerlink" title="2.4.5 模板（templates）"></a>2.4.5 模板（templates）</h3><p>基于Python的Jinja2模板引擎（和django的模板引擎很类似），模板文件可以包含模板变量。这里的文件应该以.j2为类型后缀（eg.uwsgi.j2），提倡但是不强制，也可以取其他的名字。类似于files，在templates目录中没有main.yml文件，只包含.j2后缀的模板文件。<br>这是一个Nginx服务器（“虚拟主机”）配置的例子。请注意，它使用了稍后在vars/main.yml文件中定义的一些变量。<br>我们的示例中的Nginx配置文件位于templates/serversforhackers.com.conf.j2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    # Enforce the use of HTTPS</span><br><span class="line">    listen 80 default_server;</span><br><span class="line">    server_name &#123;&#123; domain &#125;&#125;;</span><br><span class="line">    return 301 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl default_server;</span><br><span class="line"></span><br><span class="line">    root /var/www/&#123;&#123; domain &#125;&#125;/public;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line">    access_log /var/log/nginx/&#123;&#123; domain &#125;&#125;.log;</span><br><span class="line">    error_log  /var/log/nginx/&#123;&#123; domain &#125;&#125;-error.log error;</span><br><span class="line"></span><br><span class="line">    server_name &#123;&#123; domain &#125;&#125;;</span><br><span class="line"></span><br><span class="line">    charset utf-8;</span><br><span class="line"></span><br><span class="line">    include h5bp/basic.conf;</span><br><span class="line"></span><br><span class="line">    ssl_certificate           &#123;&#123; ssl_crt &#125;&#125;;</span><br><span class="line">    ssl_certificate_key       &#123;&#123; ssl_key &#125;&#125;;</span><br><span class="line">    include h5bp/directive-only/ssl.conf;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ /index.php$is_args$args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location = /favicon.ico &#123; log_not_found off; access_log off; &#125;</span><br><span class="line">    location = /robots.txt  &#123; log_not_found off; access_log off; &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        include snippets/fastcgi.conf;</span><br><span class="line">        fastcgi_pass unix:/var/run/php7.1-fpm.sock;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;1234567891011121314151617181920212223242526272829303132333435363738</span><br></pre></td></tr></table></figure>
<p>这是一个相当标准的用于PHP应用程序的Nginx配置。这里有三个变量：</p>
<p>域<br>ssl_crt<br>ssl_key<br>这三个变量将在变量部分（vars）中定义。</p>
<h3 id="2-4-6-变量（vars）"><a href="#2-4-6-变量（vars）" class="headerlink" title="2.4.6 变量（vars）"></a>2.4.6 变量（vars）</h3><p>在使用任务集成所有事情之前，让我们来看看变量。该vars目录包含一个main.yml文件（如handlers和meta目录一样），在main.yml中我们可以列出将要使用的所有变量。<br>以下是该vars/main.yml文件的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">domain: serversforhackers.com</span><br><span class="line">ssl_key: /etc/ssl/sfh/sfh.key</span><br><span class="line">ssl_crt: /etc/ssl/sfh/sfh.crt1234</span><br></pre></td></tr></table></figure>
<p>我们可以在这个角色的其他地方使用这三个变量。我们在上面的模板中看到它们的使用，但是我们也可以在我们定义的任务中看到它们。</p>
<h5 id="Note-如果您有敏感信息添加到变量文件中，则可以使用ansible-vault加密文件，下面将对此进行说明。"><a href="#Note-如果您有敏感信息添加到变量文件中，则可以使用ansible-vault加密文件，下面将对此进行说明。" class="headerlink" title="Note:如果您有敏感信息添加到变量文件中，则可以使用ansible-vault加密文件，下面将对此进行说明。"></a>Note:如果您有敏感信息添加到变量文件中，则可以使用ansible-vault加密文件，下面将对此进行说明。</h5><h3 id="2-4-7-任务（tasks）"><a href="#2-4-7-任务（tasks）" class="headerlink" title="2.4.7 任务（tasks）"></a>2.4.7 任务（tasks）</h3><p>终于到了将一切都是放在一系列的任务中的时候了。<br>使用角色时运行的主文件是tasks/main.yml文件。看看我们的用例将会是什么样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: Add Nginx Repository</span><br><span class="line">  apt_repository:</span><br><span class="line">    repo: ppa:nginx/stable</span><br><span class="line">    state: present</span><br><span class="line"></span><br><span class="line">- name: Install Nginx</span><br><span class="line">  apt:</span><br><span class="line">    pkg: nginx</span><br><span class="line">    state: installed</span><br><span class="line">    update_cache: true</span><br><span class="line">  notify:</span><br><span class="line">    - Start Nginx</span><br><span class="line"></span><br><span class="line">- name: Add H5BP Config</span><br><span class="line">  copy:</span><br><span class="line">    src: h5bp</span><br><span class="line">    dest: /etc/nginx</span><br><span class="line">    owner: root</span><br><span class="line">    group: root</span><br><span class="line"></span><br><span class="line">- name: Disable Default Site Configuration</span><br><span class="line">  file:</span><br><span class="line">    dest: /etc/nginx/sites-enabled/default</span><br><span class="line">    state: absent</span><br><span class="line"></span><br><span class="line"># `dest` in quotes as a variable is used!</span><br><span class="line">- name: Add SFH Site Config</span><br><span class="line">  register: sfhconfig</span><br><span class="line">  template:</span><br><span class="line">    src: serversforhackers.com.j2</span><br><span class="line">    dest: &apos;/etc/nginx/sites-available/&#123;&#123; domain &#125;&#125;.conf&apos; </span><br><span class="line">    owner: root</span><br><span class="line">    group: root</span><br><span class="line"></span><br><span class="line"># `src`/`dest` in quotes as a variable is used!</span><br><span class="line">- name: Enable SFH Site Config</span><br><span class="line">  file:</span><br><span class="line">    src: &apos;/etc/nginx/sites-available/&#123;&#123; domain &#125;&#125;.conf&apos;</span><br><span class="line">    dest: &apos;/etc/nginx/sites-enabled/&#123;&#123; domain &#125;&#125;.conf&apos;</span><br><span class="line">    state: link</span><br><span class="line"></span><br><span class="line"># `dest` in quotes as a variable is used!</span><br><span class="line">- name: Create Web root</span><br><span class="line">  file:</span><br><span class="line">    dest: &apos;/var/www/&#123;&#123; domain &#125;&#125;/public&apos;</span><br><span class="line">    mode: 775</span><br><span class="line">    state: directory</span><br><span class="line">    owner: www-data</span><br><span class="line">    group: www-data</span><br><span class="line">  notify:</span><br><span class="line">    - Reload Nginx</span><br><span class="line"></span><br><span class="line"># `dest` in quotes as a variable is used!</span><br><span class="line">- name: Web Root Permissions</span><br><span class="line">  file:</span><br><span class="line">   dest: &apos;/var/www/&#123;&#123; domain &#125;&#125;&apos;</span><br><span class="line">   mode: 775</span><br><span class="line">   state: directory</span><br><span class="line">   owner: www-data</span><br><span class="line">   group: www-data</span><br><span class="line">   recurse: yes</span><br><span class="line">  notify:</span><br><span class="line">    - Reload Nginx12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364</span><br></pre></td></tr></table></figure>
<p>这一系列任务使得Nginx能被完整的安装。任务按照出现的顺序完成以下工作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1 添加nginx / stable库</span><br><span class="line">2 安装并启动Nginx</span><br><span class="line">3 添加H5BP配置文件</span><br><span class="line">4 从sites-enabled目录中删除文件的符号链接来禁用默认的Nginx配置</span><br><span class="line">5 将serversforhackers.com.conf.j2虚拟主机模板复制到Nginx配置中，渲染模板</span><br><span class="line">6 通过将其符号链接到sites-enabled目录来启用Nginx服务器配置</span><br><span class="line">7 创建Web根目录</span><br><span class="line">8 更改项目根目录的权限（递归），该目录位于之前创建的Web根目录之上12345678</span><br></pre></td></tr></table></figure>
<p>有一些新的模块（和一些我们已经涵盖的新用途），包括复制，模板和文件模块。通过设置每个模块的参数，我们可以做一些<a href="https://www.baidu.com/s?wd=%E6%9C%89%E8%B6%A3%E7%9A%84%E4%BA%8B%E6%83%85&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">有趣的事情</a>，例如确保文件“不存在”（如果存在则删除它们）的state: absent，或者通过创建一个文件作为符号链接的state: link。您应该检查每个模块的文档，以查看可以用它们完成哪些有趣和有用的事情。</p>
<h3 id="2-4-8-运行角色（Running-the-Role）"><a href="#2-4-8-运行角色（Running-the-Role）" class="headerlink" title="2.4.8 运行角色（Running the Role）"></a>2.4.8 运行角色（Running the Role）</h3><p>要对服务器运行一个或多个角色，我们将重新使用另一个playbook。该playbook与roles目录位于同一个目录中，同一层级。当我们用ansible-playbook命令运行的时候需要先cd进入到该目录中。<br>让我们创建一个“主”的yaml文件（被ansible-playbook命令执行的文件），该文件定义要使用的角色以及运行它们的主机：<br>文件~/ansible-example/server.yml位于与roles目录相同的目录中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"># run locally here, yadda yadda yadda</span><br><span class="line">- hosts: local</span><br><span class="line">  connection: local</span><br><span class="line">  roles:</span><br><span class="line">    - nginx123456</span><br></pre></td></tr></table></figure>
<p>所以，我们只是定义角色，而不是在本Playbook文件中定义所有的变量和任务。角色负责具体细节。</p>
<p>然后我们可以运行角色：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i ./hosts server.yml1</span><br></pre></td></tr></table></figure>
<p>以下是运行Nginx角色的Playbook文件的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [nginx | Add Nginx Repository] ******************************************</span><br><span class="line">changed: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [nginx | Install Nginx] *************************************************</span><br><span class="line">changed: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [nginx | Add H5BP Config] ***********************************************</span><br><span class="line">changed: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [nginx | Disable Default Site] ******************************************</span><br><span class="line">changed: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [nginx | Add SFH Site Config] *******************************************</span><br><span class="line">changed: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [nginx | Enable SFH Site Config] ****************************************</span><br><span class="line">changed: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [nginx | Create Web root] ***********************************************</span><br><span class="line">changed: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [nginx | Web Root Permissions] ******************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">NOTIFIED: [nginx | Start Nginx] ***********************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">NOTIFIED: [nginx | Reload Nginx] **********************************************</span><br><span class="line">changed: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">127.0.0.1                  : ok=8   changed=7   unreachable=0    failed=012345678910111213141516171819202122232425262728293031323334353637</span><br></pre></td></tr></table></figure>
<p>我们将所有各种组件放在一起，形成一致的角色，现在已经安装并配置了Nginx！</p>
<h2 id="2-5-事实-Facts"><a href="#2-5-事实-Facts" class="headerlink" title="2.5 事实(Facts)"></a>2.5 事实(Facts)</h2><p>请注意，运行剧本时的第一行总是“收集事实”。<br>在运行任何任务之前，Ansible将收集有关其配置的系统的信息。这些被称为事实，并且包括广泛的系统信息，如CPU核心数量，可用的ipv4和ipv6网络，挂载的磁盘，Linux发行版等等。</p>
<p>事实在“任务”或“模板”配置中通常很有用。例如，Nginx通常设置为使用与CPU内核一样多的工作处理器。知道这一点，您可以选择如下设置nginx.conf.j2文件的模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user www-data;</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_cores &#125;&#125;;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"># And other configurations...12345</span><br></pre></td></tr></table></figure>
<p>或者如果你具有多个CPU的服务器，则可以使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user www-data;</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_cores * ansible_processor_count &#125;&#125;;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"># And other configurations...12345</span><br></pre></td></tr></table></figure>
<p>所有的ansible facts全局变量都是以“anisble_”为前缀，并且可以在其他任何地方使用。<br>尝试对你的本地机器运行以下内容以查看可用的事实：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Run against a local server</span><br><span class="line"># Note that we say to use &quot;localhost&quot; instead of defining a hosts file here!</span><br><span class="line">ansible -m setup --connection=local localhost</span><br><span class="line"></span><br><span class="line"># Run against a remote server</span><br><span class="line">ansible -i ./hosts remote -m setup123456</span><br></pre></td></tr></table></figure>
<h2 id="2-6-加密（Vault）"><a href="#2-6-加密（Vault）" class="headerlink" title="2.6 加密（Vault）"></a>2.6 加密（Vault）</h2><p>我们经常需要将敏感数据存储在我们的模板，文件或变量文件中; 这样安全性有一定要求的情况是<a href="https://www.baidu.com/s?wd=%E4%B8%8D%E5%8F%AF%E9%81%BF%E5%85%8D&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">不可避免</a>的（当我们将这些敏感数据文件推送到远程Git仓库时，这是一个痛苦的事情）。Ansible有一个叫做Ansible Vault的解决方案。<br>Vault允许您加密任何Yaml文件，通常将其作用与变量文件，Vault不会加密文件和模板，只能使用Yaml文件。<br>在创建加密文件时，系统会询问您必须使用的密码，以便稍后在调用角色或Playbook时进行编辑。<br>将密码保存在安全的地方。</p>
<p>例如我们可以创建一个新的变量文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-vault create vars/main.yml</span><br><span class="line">Vault Password:12</span><br></pre></td></tr></table></figure>
<p>输入加密密码后，该文件将在您的默认编辑器（通常是Vim或Nano）中打开。<br>默认使用的编辑器由EDITOR环境变量定义。默认值通常是Vim。如果您不是Vim用户，可以通过设置环境变量来快速更改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EDITOR=nano ansible-vault edit vars/main.yml1</span><br></pre></td></tr></table></figure>
<p>在大多数情况下，我们将使用ansible-vault create|edit /path/to/file.yml。更多可用的命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create - 创建一个新文件并进行加密</span><br><span class="line">decrypt - 从加密文件创建明文文件</span><br><span class="line">edit - 编辑已经存在的加密文件</span><br><span class="line">encrypt - 加密现有的纯文本文件</span><br><span class="line">rekey - 在加密文件中设置新密码12345</span><br></pre></td></tr></table></figure>
<p>如果你有一个现有的配置文件要加密，请使用 ansible-vault encrypt /path/to/file.yml。</p>
<h3 id="示例：-users角色"><a href="#示例：-users角色" class="headerlink" title="示例： users角色"></a>示例： users角色</h3><p>我们创建一个名为“users”的角色：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/ansible-example/roles</span><br><span class="line">ansible-galaxy init users12</span><br></pre></td></tr></table></figure>
<p>创建新用户并设置密码时，我使用Vault 。在用户角色中，您可以设置带有用户密码和公钥的变量文件，以添加到用户的authorized_keys文件（从而提供SSH访问权限）。公共SSH密钥在技术上是安全的，一般公众可以看到 - 所有人都可以使用它来允许你访问自己的服务器。在没有配对私钥的情况下，公钥是不能获得系统访问权限的，我们没有将密钥加入此角色。<br>以下是可以使用Vault创建和加密的示例变量文件。在编辑它时，它是纯文本。</p>
<p>~/ansible-example/roles/users/vars/main.yml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin_password: $6$lpQ1DqjZQ25gq9YW$mHZAmGhFpPVVv0JCYUFaDovu8u5EqvQi.Ih</span><br><span class="line">deploy_password: $6$edOqVumZrYW9$d5zj1Ok/G80DrnckixhkQDpXl0fACDfNx2EHnC</span><br><span class="line">common_public_key: ssh-rsa ALongSSHPublicKeyHere123</span><br></pre></td></tr></table></figure>
<p>请注意，用户的密码也是散列的。您可以阅读Ansible有关生成加密密码的文档，用户模块需要设置用户密码。作为一个快速入门，它在Ubuntu上看起来像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># The whois package makes the mkpasswd</span><br><span class="line"># command available on Ubuntu</span><br><span class="line">$ sudo apt-get install -y whois</span><br><span class="line"></span><br><span class="line"># Create a password hash</span><br><span class="line">$ mkpasswd --method=SHA-512</span><br><span class="line">Password:1234567</span><br></pre></td></tr></table></figure>
<p>这将生成一个散列密码供你与user模块一起使用。</p>
<h5 id="Note：变量文件中的密码是散列的，但我仍然喜欢加密包含散列密码的yaml文件。这些文件通常包含未标记的数据，如API令牌或SSH私钥，使加密非常重要。"><a href="#Note：变量文件中的密码是散列的，但我仍然喜欢加密包含散列密码的yaml文件。这些文件通常包含未标记的数据，如API令牌或SSH私钥，使加密非常重要。" class="headerlink" title="Note：变量文件中的密码是散列的，但我仍然喜欢加密包含散列密码的yaml文件。这些文件通常包含未标记的数据，如API令牌或SSH私钥，使加密非常重要。"></a>Note：变量文件中的密码是散列的，但我仍然喜欢加密包含散列密码的yaml文件。这些文件通常包含未标记的数据，如API令牌或SSH私钥，使加密非常重要。</h5><p>一旦你设置了用户密码并将公钥添加到变量文件中，我们就可以加密此文件，然后在任务中使用这些加密变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-vault encrypt roles/users/vars/main.yml1</span><br></pre></td></tr></table></figure>
<p>然后我们可以编辑我们的任务文件，使用（加密）变量添加新用户：</p>
<p>这是文件~/ansible-example/roles/users/tasks/main.yml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: Create Admin User</span><br><span class="line">  user:</span><br><span class="line">    name: admin</span><br><span class="line">    password: &apos;&#123;&#123; admin_password &#125;&#125;&apos;</span><br><span class="line">    groups: sudo</span><br><span class="line">    append: yes</span><br><span class="line">    shell: /bin/bash</span><br><span class="line"></span><br><span class="line">- name: Add Admin Authorized Key</span><br><span class="line">  authorized_key:</span><br><span class="line">    user: admin</span><br><span class="line">    key: &apos;&#123;&#123; common_public_key &#125;&#125;&apos;</span><br><span class="line">    state: present</span><br><span class="line"></span><br><span class="line">- name: Create Deploy User</span><br><span class="line">  user:</span><br><span class="line">    name: deploy</span><br><span class="line">    password: &apos;&#123;&#123; deploy_password &#125;&#125;&apos;</span><br><span class="line">    groups: www-data</span><br><span class="line">    append: yes</span><br><span class="line">    shell: /bin/bash</span><br><span class="line"></span><br><span class="line">- name: Add Deployer Authorized Key</span><br><span class="line">  authorized_key:</span><br><span class="line">    user: deploy</span><br><span class="line">    key: &apos;&#123;&#123; common_public_key &#125;&#125;&apos;</span><br><span class="line">    state: present12345678910111213141516171819202122232425262728</span><br></pre></td></tr></table></figure>
<p>这些任务使用该user模块来创建新用户，传递变量文件中设置的密码。<br>它还使用该authorized_key模块将SSH公钥作为SSH授权密钥添加到每个用户的服务器中。<br>加密变量的使用像在常规任务文件中使用一样。但是，为了运行此角色，我们需要告诉Ansible请求输入vault密码，以便它可以解密变量。<br>编辑我们的server.ymlPlaybook文件，调用user角色：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"># Local connection here, yadda yadda yadda</span><br><span class="line">- hosts: local</span><br><span class="line">  connection: local</span><br><span class="line">  sudo: yes</span><br><span class="line">  roles:</span><br><span class="line">    - nginx</span><br><span class="line">    - user12345678</span><br></pre></td></tr></table></figure>
<p>要运行此Playbook，我们需要告知Ansible请求vault的密码，因为我们正在运行包含加密文件的角色：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --ask-vault-pass -i ./hosts server.yml1</span><br></pre></td></tr></table></figure>
<h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3 总结"></a>3 总结</h1><p>本篇文章带着做了如下工作：</p>
<ol>
<li><p>安装了ansible</p>
</li>
<li><p>配置了ansible inventory文件（仅在不使用connection: local 时才需要）</p>
</li>
<li><p>同时在多个服务器上执行幂等的 ad-hoc命令</p>
</li>
<li><p>创建一个基本的Playbook来运行多个任务（tasks），并使用了处理程序（handlers）</p>
</li>
<li><p>将多个任务抽象为一个角色，以保持所有Nginx相关的操作在一个角色内</p>
</li>
</ol>
<ul>
<li>展示了如何设置依赖关系</li>
<li>展示了如何注册任务的“依赖”执行关系，当一个任务执行成功后再执行另一个任务</li>
<li>展示了如何在我们的任务中使用更多的模板，文件和变量</li>
</ul>
<ol start="6">
<li><p>展示了如何整合使用ansible事实(facts)</p>
</li>
<li><p>展示了如何使用ansible的vault来增加我们的变量的安全性</p>
</li>
</ol>

    </div>
    
        <div class="reward" ontouchstart="">
    <div class="reward-wrap">赏
        <div class="reward-box">
            
            
                <span class="reward-type">
                    <img class="wechat" src="/img/wechatpay.jpg"><b>微信打赏</b>
                </span>
            
        </div>
    </div>
    <p class="reward-tip">坚持原创分享，您的支持将鼓励我继续创作！</p>
</div>


    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">Mark</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/评论/通过混沌式创新建立和增强应用程序价值/" class="pre-post btn btn-default" title="通过混沌式创新建立和增强应用程序价值">
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">通过混沌式创新建立和增强应用程序价值</span>
        </a>
    
    
        <a href="/评论/马克·扎克伯格：关于Facebook的事实/" class="next-post btn btn-default" title="马克·扎克伯格：关于Facebook的事实">
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">马克·扎克伯格：关于Facebook的事实</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: 'undefined',
            appKey: 'undefined',
            placeholder: '说点什么吧',
            notify: false,
            verify: false,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'null'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">Table of Contents</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-安装"><span class="toc-text">1 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Ubuntu"><span class="toc-text">1.1 Ubuntu</span></a></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#2-配置"><span class="toc-text">2 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-管理服务器：Inventory文件"><span class="toc-text">2.1 管理服务器：Inventory文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-基础：运行命令"><span class="toc-text">2.2 基础：运行命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-模块（Modules）"><span class="toc-text">2.2.1 模块（Modules）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#模块是使用Ansible-的方法"><span class="toc-text">模块是使用Ansible 的方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-剧本（Playbooks）"><span class="toc-text">2.3 剧本（Playbooks）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-处理程序（Handlers）"><span class="toc-text">2.3.1 处理程序（Handlers）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Note：如果我已经安装了Nginx，则安装Nginx任务将不会运行，通知程序也将不会被调用。"><span class="toc-text">Note：如果我已经安装了Nginx，则安装Nginx任务将不会运行，通知程序也将不会被调用。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-更多的任务（More-Tasks）"><span class="toc-text">2.3.2 更多的任务（More Tasks）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Note-您还可以注册模块操作的结果，并使用定义的变量根据注册（register）的变量值有条件（when）地执行操作。例如，注册通过shell模块运行命令的结果可以让您访问该命令的stdout。"><span class="toc-text">Note: 您还可以注册模块操作的结果，并使用定义的变量根据注册（register）的变量值有条件（when）地执行操作。例如，注册通过shell模块运行命令的结果可以让您访问该命令的stdout。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-角色（roles）"><span class="toc-text">2.4 角色（roles）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-创建角色（Creating-a-Role）"><span class="toc-text">2.4.1 创建角色（Creating a Role）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-文件（files）"><span class="toc-text">2.4.2 文件（files）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-3-处理程序（handlers）"><span class="toc-text">2.4.3 处理程序（handlers）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-4-元（meta）"><span class="toc-text">2.4.4 元（meta）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-5-模板（templates）"><span class="toc-text">2.4.5 模板（templates）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-6-变量（vars）"><span class="toc-text">2.4.6 变量（vars）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Note-如果您有敏感信息添加到变量文件中，则可以使用ansible-vault加密文件，下面将对此进行说明。"><span class="toc-text">Note:如果您有敏感信息添加到变量文件中，则可以使用ansible-vault加密文件，下面将对此进行说明。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-7-任务（tasks）"><span class="toc-text">2.4.7 任务（tasks）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-8-运行角色（Running-the-Role）"><span class="toc-text">2.4.8 运行角色（Running the Role）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-事实-Facts"><span class="toc-text">2.5 事实(Facts)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-加密（Vault）"><span class="toc-text">2.6 加密（Vault）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#示例：-users角色"><span class="toc-text">示例： users角色</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Note：变量文件中的密码是散列的，但我仍然喜欢加密包含散列密码的yaml文件。这些文件通常包含未标记的数据，如API令牌或SSH私钥，使加密非常重要。"><span class="toc-text">Note：变量文件中的密码是散列的，但我仍然喜欢加密包含散列密码的yaml文件。这些文件通常包含未标记的数据，如API令牌或SSH私钥，使加密非常重要。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-总结"><span class="toc-text">3 总结</span></a></li>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2017
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>