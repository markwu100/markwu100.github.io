<!DOCTYPE HTML>
<html lang="null">
<head><meta name="generator" content="Hexo 3.8.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="Cloud Service一站通">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://blog.ozairs.com">
    <!--SEO-->

    <meta name="keywords" content="Docker">


    <meta name="description" content="
Docker Machine 创建 Docker 主机
Docker Swarm 配置集群节点
Docker Service 部署单个集群服务
Docker Stack 部署多个集群服务，以及...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>Docker三剑客之Docker Swarm | Cloud Service一站通</title>


    <link rel="alternate" href="/atom.xml" title="Cloud Service一站通" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>





	<script>
		(function(i, s, o, g, r, a, m) {
		    i['GoogleAnalyticsObject'] = r;
		    i[r] = i[r] || function() {
		        (i[r].q = i[r].q || []).push(arguments)
		    }, i[r].l = 1 * new Date();
		    a = s.createElement(o),
		    m = s.getElementsByTagName(o)[0];
		    a.async = 1;
		    a.src = g;
		    m.parentNode.insertBefore(a, m)
		})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
		ga('create', 'UA-136105852-1', 'auto');
		ga('send', 'pageview');
	</script>


    

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header">
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="Mark Wu">
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                 <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://blog.ozairs.com">Cloud Service一站通</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>Main</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/AWS"><i class="fa "></i>AWS</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Ansible"><i class="fa "></i>Ansible</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Cloud-Service"><i class="fa "></i>Cloud Service</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Security"><i class="fa "></i>Security</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/DevOps"><i class="fa "></i>DevOps</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Docker"><i class="fa "></i>Docker</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Jenkins"><i class="fa "></i>Jenkins</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Kubernetes"><i class="fa "></i>Kubernetes</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Python"><i class="fa "></i>Python</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Terraform"><i class="fa "></i>Terraform</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>Archives</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="https://156709406.gitbook.io/markwu100/"><i class="fa "></i>《Go Terraform》Chinese Version</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Docker三剑客之Docker Swarm">
            
	            Docker三剑客之Docker Swarm
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/Docker/">Docker</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/Docker/">Docker</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/03/16</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>374</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <ul>
<li><strong>Docker Machine 创建 Docker 主机</strong></li>
<li><strong>Docker Swarm 配置集群节点</strong></li>
<li><strong>Docker Service 部署单个集群服务</strong></li>
<li><strong>Docker Stack 部署多个集群服务，以及 GUI 管理页面</strong></li>
<li><strong>docker-machine、docker swarm、docker node、docker service 和 docker stack 常用命令</strong></li>
</ul>
<p><a href="https://docs.docker.com/engine/swarm/" target="_blank" rel="noopener">Docker Swarm</a> 和 Docker Compose 一样，都是 Docker 官方容器编排项目，但不同的是，Docker Compose 是一个在单个服务器或主机上创建多个容器的工具，而 Docker Swarm 则可以在多个服务器或主机上创建容器集群服务，对于微服务的部署，显然 Docker Swarm 会更加适合。</p>
<p>从 Docker 1.12.0 版本开始，Docker Swarm 已经包含在 Docker 引擎中（<code>docker swarm</code>），并且已经内置了服务发现工具，我们就不需要像之前一样，再配置 Etcd 或者 <a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-consul-docker-swarm/index.html" target="_blank" rel="noopener">Consul</a> 来进行服务发现配置了。</p>
<h2 id="1-Docker-Machine-创建-Docker-主机"><a href="#1-Docker-Machine-创建-Docker-主机" class="headerlink" title="1. Docker Machine 创建 Docker 主机"></a>1. Docker Machine 创建 Docker 主机</h2><p>在进行 Docker Swarm 配置之前，我们还需要说下 Docker 另外一个官方工具 Docker Machine（也是 Docker 三剑客之一），其作用就是快速帮助我们搭建 Docker 主机环境，比如我们要使用 Docker Swarm，就必须有很多的 Docker 主机来进行操作，Docker Machine 就是最理想的工具。</p>
<p>因为我是在 Mac OS 上进行操作的，并且 Docker for Mac 已经包含了 Docker Machine（<code>docker machine</code>），所以我不需要再额外进行安装了，如果使用 Linux 系统的话，安装也非常简单，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo curl -L https://github.com/docker/machine/releases/download/v0.13.0/docker-machine-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-machine</span><br><span class="line">$ sudo chmod +x /usr/local/bin/docker-machine</span><br></pre></td></tr></table></figure>
<p>好了，我们先使用 Docker Machine 创建四个 Docker 主机，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine create -d virtualbox manager1 &amp;&amp; </span><br><span class="line">docker-machine create -d virtualbox manager2 &amp;&amp; </span><br><span class="line">docker-machine create -d virtualbox worker1 &amp;&amp; </span><br><span class="line">docker-machine create -d virtualbox worker2</span><br><span class="line"></span><br><span class="line">Running pre-create checks...</span><br><span class="line">(worker1) No default Boot2Docker ISO found locally, downloading the latest release...</span><br><span class="line">(worker1) Latest release for github.com/boot2docker/boot2docker is v17.11.0-ce</span><br><span class="line">(worker1) Downloading /Users/xishuai/.docker/machine/cache/boot2docker.iso from https://github.com/boot2docker/boot2docker/releases/download/v17.11.0-ce/boot2docker.iso...</span><br></pre></td></tr></table></figure>
<p>执行上面命令，你会发现速度巨慢（如上），原因是从 GitHub 上下载一个<code>boot2docker.iso</code>文件（国内网络没办法），怎么解决呢？很简单，我们使用翻X的浏览器手动下载<code>boot2docker.iso</code>文件，然后拷贝到对应目录下（我电脑的目录<code>/Users/xishuai/.docker/machine/cache/</code>），然后再执行上面的命令，发现速度快的一批。</p>
<p>我们可以查看下创建的 Docker 主机信息，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine ls</span><br><span class="line">NAME       ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER        ERRORS</span><br><span class="line">manager1   -        virtualbox   Running   tcp://192.168.99.100:2376           v17.11.0-ce   </span><br><span class="line">manager2   -        virtualbox   Running   tcp://192.168.99.101:2376           v17.11.0-ce   </span><br><span class="line">worker1    -        virtualbox   Running   tcp://192.168.99.102:2376           v17.11.0-ce   </span><br><span class="line">worker2    -        virtualbox   Running   tcp://192.168.99.103:2376           v17.11.0-ce</span><br></pre></td></tr></table></figure>
<p>可以看到，我们创建了四个 Docker 主机（两个 Manager 和两个 Worker），我们还可以连接到任何一台服务器进行操作，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine ssh manager1</span><br><span class="line">                        ##         .</span><br><span class="line">                  ## ## ##        ==</span><br><span class="line">               ## ## ## ## ##    ===</span><br><span class="line">           /&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;\___/ ===</span><br><span class="line">      ~~~ &#123;~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~</span><br><span class="line">           \______ o           __/</span><br><span class="line">             \    \         __/</span><br><span class="line">              \____\_______/</span><br><span class="line"> _                 _   ____     _            _</span><br><span class="line">| |__   ___   ___ | |_|___ \ __| | ___   ___| | _____ _ __</span><br><span class="line">| &apos;_ \ / _ \ / _ \| __| __) / _` |/ _ \ / __| |/ / _ \ &apos;__|</span><br><span class="line">| |_) | (_) | (_) | |_ / __/ (_| | (_) | (__|   &lt;  __/ |</span><br><span class="line">|_.__/ \___/ \___/ \__|_____\__,_|\___/ \___|_|\_\___|_|</span><br><span class="line">Boot2Docker version 17.11.0-ce, build HEAD : e620608 - Tue Nov 21 18:11:40 UTC 2017</span><br><span class="line">Docker version 17.11.0-ce, build 1caf76c</span><br></pre></td></tr></table></figure>
<h2 id="2-Docker-Swarm-配置集群节点"><a href="#2-Docker-Swarm-配置集群节点" class="headerlink" title="2. Docker Swarm 配置集群节点"></a>2. Docker Swarm 配置集群节点</h2><p>我们执行下面命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine ssh manager1 &quot;docker swarm init --advertise-addr 192.168.99.100&quot;</span><br><span class="line">Swarm initialized: current node (n0ub7dpn90rxjq97dr0g8we0w) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-5uwpqibnvmho1png8zmhcw8274yanohee32jyrcjlait9djhsk-envtxo4dl6df2ar3qldcccfdg 192.168.99.100:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</span><br></pre></td></tr></table></figure>
<p>上面是在<code>manager1</code>主机上，创建一个 Docker Swarm 管理节点（初始化集群的时候，会自动把当前节点设置为管理节点）。</p>
<p>接着，我们在<code>worker1</code>和<code>worker2</code>主机上，创建两个工作节点，并加入到集群中，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine ssh worker1 &quot;docker swarm join --token SWMTKN-1-5uwpqibnvmho1png8zmhcw8274yanohee32jyrcjlait9djhsk-envtxo4dl6df2ar3qldcccfdg 192.168.99.100:2377&quot;</span><br><span class="line">This node joined a swarm as a worker.</span><br><span class="line"></span><br><span class="line">$ docker-machine ssh worker2 &quot;docker swarm join --token SWMTKN-1-5uwpqibnvmho1png8zmhcw8274yanohee32jyrcjlait9djhsk-envtxo4dl6df2ar3qldcccfdg 192.168.99.100:2377&quot;</span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>
<p>还有另外一个<code>manager2</code>主机，需要配置为管理节点，我们需要先在<code>manager1</code>主机上，获取管理节点对应的<code>token</code>，然后再配置为管理节点，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine ssh manager1 &quot;docker swarm join-token manager&quot;</span><br><span class="line">To add a manager to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-5uwpqibnvmho1png8zmhcw8274yanohee32jyrcjlait9djhsk-0koz1b98sco8r5cn3g61eahnu 192.168.99.100:2377</span><br><span class="line"></span><br><span class="line">$ docker-machine ssh manager2 &quot;docker swarm join --token SWMTKN-1-5uwpqibnvmho1png8zmhcw8274yanohee32jyrcjlait9djhsk-0koz1b98sco8r5cn3g61eahnu 192.168.99.100:2377&quot;</span><br><span class="line">This node joined a swarm as a manager.</span><br></pre></td></tr></table></figure>
<p>配置好之后，我们进入<code>manager1</code>主机内（上面的命令也可以在主机内执行），然后查看集群节点的信息，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker node ls</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS</span><br><span class="line">n0ub7dpn90rxjq97dr0g8we0w *   manager1            Ready               Active              Leader</span><br><span class="line">t4cy67qp0bf2spgabsutwxnzt     manager2            Ready               Active              Reachable</span><br><span class="line">if0kmzp4ww3oy57y7cha7v36t     worker1             Ready               Active              </span><br><span class="line">jgg61cujzaeb3du5796fm0x2g     worker2             Ready               Active</span><br></pre></td></tr></table></figure>
<p><code>Leader</code>表示当然集群的头，<code>Reachable</code>可以理解为头的候选人，头一挂掉它就顶上去了。</p>
<hr>
<p>需要注意的是，我当天配置好之后，把所有的 Docker 主机都<code>stop</code>了，然后隔天重新<code>start</code>之后，出现了下面问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker node ls</span><br><span class="line">Error response from daemon: rpc error: code = Unknown desc = The swarm does not have a leader. It&apos;s possible that too few managers are online. Make sure more than half of the managers are online.</span><br></pre></td></tr></table></figure>
<p>好像是集群节点丢失了头，相关问题：<a href="https://q.cnblogs.com/q/96996/" target="_blank" rel="noopener">如何处理 docker swarm 集群”The swarm does not have a leader”问题</a>，按照文章进行解决：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm init --force-new-cluster</span><br><span class="line">Error response from daemon: could not choose an IP address to advertise since this system has multiple addresses on different interfaces (10.0.2.15 on eth0 and 192.168.99.102 on eth1) - specify one with --advertise-addr</span><br><span class="line">$ docker swarm init --force-new-cluster --advertise-addr 192.168.99.102</span><br><span class="line">Error response from daemon: This node is not a swarm manager. Worker nodes can&apos;t be used to view or modify cluster state. Please run this command on a manager node or promote the current node to a manager.</span><br><span class="line">$ docker node ls</span><br><span class="line">卡死</span><br><span class="line">$ docker-machine restart manager1 </span><br><span class="line">重启不了，一直转圈</span><br></pre></td></tr></table></figure>
<p>没办法，后来我只能删掉四个 Docker 主机，重新进行创建了。</p>
<h2 id="3-Docker-Service-部署单个集群服务"><a href="#3-Docker-Service-部署单个集群服务" class="headerlink" title="3. Docker Service 部署单个集群服务"></a>3. Docker Service 部署单个集群服务</h2><p>在部署集群服务之前，我们需要做些准备工作，因为 Docker 主机中没有配置 Docker 镜像加速地址，所以在拉取官方镜像的时候，肯定会非常慢，除了配置 Docker 镜像加速地址之外，我们还可以使用 Docker 私有镜像仓库，来解决这个问题。</p>
<p>参考文章：<a href="http://www.cnblogs.com/xishuai/p/ubuntu-docker-registry.html" target="_blank" rel="noopener">Ubuntu Docker Registry 搭建私有仓库</a></p>
<p>这边，我再简单说明下配置步骤，首先，在 Mac OS 上执行下面命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -v /Users/xishuai/Documents/Docker:/var/lib/registry -p 5000:5000 --restart=always --name registry registry</span><br><span class="line"></span><br><span class="line">$ docker tag nginx 192.168.99.1:5000/nginx:latest &amp;&amp; </span><br><span class="line">docker push 192.168.99.1:5000/nginx:latest &amp;&amp; </span><br><span class="line">docker pull 192.168.99.1:5000/nginx:latest</span><br><span class="line"></span><br><span class="line">$ curl http://192.168.99.1:5000/v2/_catalog</span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;nginx&quot;]&#125;</span><br></pre></td></tr></table></figure>
<p>我们在 Mac OS 上创建了一个私有仓库容器，并把<code>nginx</code>镜像放到私有仓库中，因为没有使用 Https，所以在拉取和推送镜像的时候，会报如下错误（Mac OS 和 Docker 主机都会报错）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull 192.168.99.1:5000/nginx:latest</span><br><span class="line">The push refers to a repository [192.168.99.1:5000/nginx]</span><br><span class="line">Get https://192.168.99.1:5000/v1/_ping: http: server gave HTTP response to HTTPS client</span><br></pre></td></tr></table></figure>
<p>解决方式，我们需要分别在四个 Docker 主机中添加配置（Docker for Mac 在管理界面配置即可），命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo touch /etc/docker/daemon.json &amp;&amp; </span><br><span class="line">sudo chmod 777 /etc/docker/daemon.json &amp;&amp; </span><br><span class="line">sudo echo &apos;&#123; &quot;insecure-registries&quot;:    [&quot;192.168.99.1:5000&quot;] &#125;&apos; &gt; /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>
<p>然后重启四个 Docker 主机（Docker for Mac 也需要重启），命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine restart manager1 &amp;&amp; </span><br><span class="line">docker-machine restart manager2 &amp;&amp; </span><br><span class="line">docker-machine restart worker1 &amp;&amp; </span><br><span class="line">docker-machine restart worker2</span><br></pre></td></tr></table></figure>
<hr>
<p>上面比较啰嗦，我们接下来正式部署集群服务，还是拿<code>nginx</code>镜像做为示例，命令（<code>docker service create</code>命令<a href="http://www.yiibai.com/docker/service_create.html" target="_blank" rel="noopener">详细说明</a>）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker service create --replicas 4 -p 8088:80 --name nginx 192.168.99.1:5000/nginx:latest</span><br><span class="line">ap8h8srb8yh3mni0h2nz61njz</span><br><span class="line">overall progress: 4 out of 4 tasks </span><br><span class="line">1/4: running   [==================================================&gt;] </span><br><span class="line">2/4: running   [==================================================&gt;] </span><br><span class="line">3/4: running   [==================================================&gt;] </span><br><span class="line">4/4: running   [==================================================&gt;] </span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>
<p>需要注意的是，<code>--replicas 4</code>表示创建服务的实例个数（默认是一个），啥意思？比如4，就是在四个 Docker 主机上，分别创建一个<code>nginx</code>服务，如果是3，那就是三个 Docker 主机，或者你可以理解为 Docker 主机的个数，另外，<code>REPLICAS</code>会有进度显示，并且执行是异步的。</p>
<p>我们也可以手动设置实例个数，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker service scale nginx=4</span><br></pre></td></tr></table></figure>
<p>部署好服务后，我们就可以进行查看了，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE                            PORTS</span><br><span class="line">ap8h8srb8yh3        nginx               replicated          4/4                 192.168.99.1:5000/nginx:latest   *:8080-&gt;8080/tcp</span><br><span class="line"></span><br><span class="line">$ docker service ps nginx</span><br><span class="line">ID                  NAME                IMAGE                            NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS</span><br><span class="line">l2rdrwzs5zog        nginx.1             192.168.99.1:5000/nginx:latest   manager1            Running             Running about a minute ago                       </span><br><span class="line">vsfczzbwanx3        nginx.2             192.168.99.1:5000/nginx:latest   manager2            Running             Running about a minute ago                           </span><br><span class="line">qtbgw5h6dsi9        nginx.3             192.168.99.1:5000/nginx:latest   worker              Running             Running about a minute ago                           </span><br><span class="line">za2ejnvb3n6z        nginx.4             192.168.99.1:5000/nginx:latest   worker2             Running             Running about a minute ago</span><br></pre></td></tr></table></figure>
<p>我们任意使用四个 Docker 主机中的一个 IP 地址，浏览器打开：<a href="http://192.168.99.100:8088/" target="_blank" rel="noopener">http://192.168.99.100:8088/</a></p>
<p><img src="/Docker/Docker三剑客之Docker-Swarm/1.png" alt=""></p>
<h2 id="4-Docker-Stack-部署多个集群服务，以及-GUI-管理页面"><a href="#4-Docker-Stack-部署多个集群服务，以及-GUI-管理页面" class="headerlink" title="4. Docker Stack 部署多个集群服务，以及 GUI 管理页面"></a>4. Docker Stack 部署多个集群服务，以及 GUI 管理页面</h2><p><code>docker service</code>部署的是单个服务，我们可以使用<code>docker stack</code>进行多服务编排部署，使用的同样是<code>docker-compose.yml</code>配置文件，示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: 192.168.99.1:5000/nginx:latest</span><br><span class="line">    ports:</span><br><span class="line">      - 8088:80</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: 4</span><br><span class="line"></span><br><span class="line">  visualizer:</span><br><span class="line">    image: 192.168.99.1:5000/dockersamples/visualizer:latest</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8080:8080&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - &quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: 1</span><br><span class="line">      placement:</span><br><span class="line">        constraints: [node.role == manager]</span><br><span class="line"></span><br><span class="line">  portainer:</span><br><span class="line">    image: 192.168.99.1:5000/portainer/portainer:latest</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;9000:9000&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - &quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: 1</span><br><span class="line">      placement:</span><br><span class="line">        constraints: [node.role == manager]</span><br></pre></td></tr></table></figure>
<p>如上所示，我们总共需要部署三个服务，出了<code>nginx</code>服务作为示例之外，<code>visualizer</code>（<a href="https://github.com/dockersamples/docker-swarm-visualizer" target="_blank" rel="noopener">官方地址</a>）和<code>portainer</code>（<a href="https://portainer.io/" target="_blank" rel="noopener">官方地址</a>）都是集群 GUI 管理服务。</p>
<p>部署命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker stack deploy -c docker-compose.yml deploy-demo</span><br><span class="line">Creating service deploy-demo_nginx</span><br><span class="line">Creating service deploy-demo_visualizer</span><br><span class="line">Creating service deploy-demo_portainer</span><br></pre></td></tr></table></figure>
<p>部署成功之后，我们可以查看具体详情，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker stack ls</span><br><span class="line">NAME                SERVICES</span><br><span class="line">deploy-demo         3</span><br></pre></td></tr></table></figure>
<p>查看<code>visualizer</code>GUI 集群管理，浏览器打开：<a href="http://192.168.99.100:8080/" target="_blank" rel="noopener">http://192.168.99.100:8080/</a></p>
<p><img src="/Docker/Docker三剑客之Docker-Swarm/2.png" alt=""></p>
<p>查看<code>portainer</code>GUI 集群管理，需要先配置账号信息，浏览器打开：<a href="http://192.168.99.100:9000/" target="_blank" rel="noopener">http://192.168.99.100:9000/</a></p>
<p><img src="/Docker/Docker三剑客之Docker-Swarm/3.gif" alt=""></p>
<p>可以看到，<code>portainer</code>比<code>visualizer</code>强大太多了，甚至我们所有的操作都可以在<code>portainer</code>上完成。</p>
<h2 id="5-docker-machine、docker-swarm、docker-node、docker-service-和-docker-stack-常用命令"><a href="#5-docker-machine、docker-swarm、docker-node、docker-service-和-docker-stack-常用命令" class="headerlink" title="5. docker-machine、docker swarm、docker node、docker service 和 docker stack 常用命令"></a>5. docker-machine、docker swarm、docker node、docker service 和 docker stack 常用命令</h2><h3 id="docker-machine-常用命令"><a href="#docker-machine-常用命令" class="headerlink" title="docker-machine 常用命令"></a>docker-machine 常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker-machine create</td>
<td>创建一个 Docker 主机（常用<code>-d virtualbox</code>）</td>
</tr>
<tr>
<td>docker-machine ls</td>
<td>查看所有的 Docker 主机</td>
</tr>
<tr>
<td>docker-machine ssh</td>
<td>SSH 到主机上执行命令</td>
</tr>
<tr>
<td>docker-machine env</td>
<td>显示连接到某个主机需要的环境变量</td>
</tr>
<tr>
<td>docker-machine inspect</td>
<td>输出主机更多信息</td>
</tr>
<tr>
<td>docker-machine kill</td>
<td>停止某个主机</td>
</tr>
<tr>
<td>docker-machine restart</td>
<td>重启某台主机</td>
</tr>
<tr>
<td>docker-machine rm</td>
<td>删除某台主机</td>
</tr>
<tr>
<td>docker-machine scp</td>
<td>在主机之间复制文件</td>
</tr>
<tr>
<td>docker-machine start</td>
<td>启动一个主机</td>
</tr>
<tr>
<td>docker-machine status</td>
<td>查看主机状态</td>
</tr>
<tr>
<td>docker-machine stop</td>
<td>停止一个主机</td>
</tr>
</tbody>
</table>
<h3 id="docker-swarm-常用命令"><a href="#docker-swarm-常用命令" class="headerlink" title="docker swarm 常用命令"></a>docker swarm 常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker swarm init</td>
<td>初始化集群</td>
</tr>
<tr>
<td>docker swarm join-token worker</td>
<td>查看工作节点的 token</td>
</tr>
<tr>
<td>docker swarm join-token manager</td>
<td>查看管理节点的 token</td>
</tr>
<tr>
<td>docker swarm join</td>
<td>加入集群中</td>
</tr>
</tbody>
</table>
<h3 id="docker-node-常用命令"><a href="#docker-node-常用命令" class="headerlink" title="docker node 常用命令"></a>docker node 常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker node ls</td>
<td>查看所有集群节点</td>
</tr>
<tr>
<td>docker node rm</td>
<td>删除某个节点（<code>-f</code>强制删除）</td>
</tr>
<tr>
<td>docker node inspect</td>
<td>查看节点详情</td>
</tr>
<tr>
<td>docker node demote</td>
<td>节点降级，由管理节点降级为工作节点</td>
</tr>
<tr>
<td>docker node promote</td>
<td>节点升级，由工作节点升级为管理节点</td>
</tr>
<tr>
<td>docker node update</td>
<td>更新节点</td>
</tr>
<tr>
<td>docker node ps</td>
<td>查看节点中的 Task 任务</td>
</tr>
</tbody>
</table>
<h3 id="docker-service-常用命令"><a href="#docker-service-常用命令" class="headerlink" title="docker service 常用命令"></a>docker service 常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker service create</td>
<td>部署服务</td>
</tr>
<tr>
<td>docker service inspect</td>
<td>查看服务详情</td>
</tr>
<tr>
<td>docker service logs</td>
<td>产看某个服务日志</td>
</tr>
<tr>
<td>docker service ls</td>
<td>查看所有服务详情</td>
</tr>
<tr>
<td>docker service rm</td>
<td>删除某个服务（<code>-f</code>强制删除）</td>
</tr>
<tr>
<td>docker service scale</td>
<td>设置某个服务个数</td>
</tr>
<tr>
<td>docker service update</td>
<td>更新某个服务</td>
</tr>
</tbody>
</table>
<h3 id="docker-stack-常用命令"><a href="#docker-stack-常用命令" class="headerlink" title="docker stack 常用命令"></a>docker stack 常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker stack deploy</td>
<td>部署新的堆栈或更新现有堆栈</td>
</tr>
<tr>
<td>docker stack ls</td>
<td>列出现有堆栈</td>
</tr>
<tr>
<td>docker stack ps</td>
<td>列出堆栈中的任务</td>
</tr>
<tr>
<td>docker stack rm</td>
<td>删除堆栈</td>
</tr>
<tr>
<td>docker stack services</td>
<td>列出堆栈中的服务</td>
</tr>
<tr>
<td>docker stack down</td>
<td>移除某个堆栈（不会删除数据）</td>
</tr>
</tbody>
</table>
<p>参考资料：</p>
<ul>
<li><a href="https://docs.docker.com/get-started/part4/" target="_blank" rel="noopener">Get Started, Part 4: Swarms</a></li>
<li><a href="https://github.com/yeasy/docker_practice/tree/master/swarm" target="_blank" rel="noopener">Docker 三剑客之 Docker Swarm</a></li>
<li><a href="http://www.jianshu.com/p/9eb9995884a5" target="_blank" rel="noopener">Docker Swarm 入门一篇文章就够了</a></li>
<li><a href="http://www.huangxiaobai.com/archives/2135" target="_blank" rel="noopener">Docker 的命令之集群节点管理 Swarm node</a></li>
<li><a href="http://www.yiibai.com/docker/service.html" target="_blank" rel="noopener">docker service 命令</a></li>
<li><a href="https://www.centos.bz/2017/01/docker-service-create/" target="_blank" rel="noopener">Docker 命令行参考(37) – docker service create 创建一个服务</a></li>
<li><a href="http://www.cnblogs.com/sparkdev/p/7044950.html" target="_blank" rel="noopener">Docker Machine 是什么？</a></li>
<li><a href="http://blog.csdn.net/wanglei_storage/article/details/77508620" target="_blank" rel="noopener">docker swarm 学习命令整理</a></li>
</ul>

    </div>
    
        <div class="reward" ontouchstart="">
    <div class="reward-wrap">赏
        <div class="reward-box">
            
            
                <span class="reward-type">
                    <img class="wechat" src="/img/wechatpay.jpg"><b>微信打赏</b>
                </span>
            
        </div>
    </div>
    <p class="reward-tip">坚持原创分享，您的支持将鼓励我继续创作！</p>
</div>


    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">Mark</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/Docker/如何编写最佳的Dockerfile/" class="pre-post btn btn-default" title="如何编写最佳的Dockerfile">
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">如何编写最佳的Dockerfile</span>
        </a>
    
    
        <a href="/Docker/Docker-Swarm入门一篇文章就够了/" class="next-post btn btn-default" title="Docker Swarm入门一篇文章就够了">
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">Docker Swarm入门一篇文章就够了</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: 'undefined',
            appKey: 'undefined',
            placeholder: '说点什么吧',
            notify: false,
            verify: false,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'null'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">Table of Contents</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Docker-Machine-创建-Docker-主机"><span class="toc-text">1. Docker Machine 创建 Docker 主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Docker-Swarm-配置集群节点"><span class="toc-text">2. Docker Swarm 配置集群节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Docker-Service-部署单个集群服务"><span class="toc-text">3. Docker Service 部署单个集群服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Docker-Stack-部署多个集群服务，以及-GUI-管理页面"><span class="toc-text">4. Docker Stack 部署多个集群服务，以及 GUI 管理页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-docker-machine、docker-swarm、docker-node、docker-service-和-docker-stack-常用命令"><span class="toc-text">5. docker-machine、docker swarm、docker node、docker service 和 docker stack 常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-machine-常用命令"><span class="toc-text">docker-machine 常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-swarm-常用命令"><span class="toc-text">docker swarm 常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-node-常用命令"><span class="toc-text">docker node 常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-service-常用命令"><span class="toc-text">docker service 常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-stack-常用命令"><span class="toc-text">docker stack 常用命令</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2017
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>