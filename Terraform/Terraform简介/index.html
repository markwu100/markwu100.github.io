<!DOCTYPE HTML>
<html lang="null">
<head><meta name="generator" content="Hexo 3.8.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="Cloud Service一站通">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://blog.ozairs.com">
    <!--SEO-->

    <meta name="keywords" content="null">


    <meta name="description" content="这是Terraform系列综合指南的第2部分。在第1部分中，我们解释了为什么我们选择Terraform作为我们选择的IAC工具而不是Chef，Puppet，Ansible，SaltStack或C...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>Terraform简介 | Cloud Service一站通</title>


    <link rel="alternate" href="/atom.xml" title="Cloud Service一站通" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>





	<script>
		(function(i, s, o, g, r, a, m) {
		    i['GoogleAnalyticsObject'] = r;
		    i[r] = i[r] || function() {
		        (i[r].q = i[r].q || []).push(arguments)
		    }, i[r].l = 1 * new Date();
		    a = s.createElement(o),
		    m = s.getElementsByTagName(o)[0];
		    a.async = 1;
		    a.src = g;
		    m.parentNode.insertBefore(a, m)
		})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
		ga('create', 'UA-136105852-1', 'auto');
		ga('send', 'pageview');
	</script>


    

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header">
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="Mark Wu">
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                 <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://blog.ozairs.com">Cloud Service一站通</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>Main</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/AWS"><i class="fa "></i>AWS</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Ansible"><i class="fa "></i>Ansible</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Cloud-Service"><i class="fa "></i>Cloud Service</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Security"><i class="fa "></i>Security</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/DevOps"><i class="fa "></i>DevOps</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Docker"><i class="fa "></i>Docker</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Jenkins"><i class="fa "></i>Jenkins</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Kubernetes"><i class="fa "></i>Kubernetes</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Python"><i class="fa "></i>Python</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Terraform"><i class="fa "></i>Terraform</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>Archives</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="https://156709406.gitbook.io/markwu100/"><i class="fa "></i>《Go Terraform》Chinese Version</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Terraform简介">
            
	            Terraform简介
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/Terraform/">Terraform</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/03/30</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>359</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>这是<a href="https://blog.gruntwork.io/a-comprehensive-guide-to-terraform-b3d32832baca#.b6sun4nkn" target="_blank" rel="noopener">Terraform</a>系列<a href="https://blog.gruntwork.io/a-comprehensive-guide-to-terraform-b3d32832baca#.b6sun4nkn" target="_blank" rel="noopener">综合指南的</a>第2部分。在第1部分中，我们解释了<a href="https://blog.gruntwork.io/why-we-use-terraform-and-not-chef-puppet-ansible-saltstack-or-cloudformation-7989dad2865c#.63ls7fpkq" target="_blank" rel="noopener">为什么我们选择Terraform作为我们选择的IAC工具而不是Chef，Puppet，Ansible，SaltStack或CloudFormation</a>。在这篇文章中，我们将介绍如何使用Terraform定义和管理基础架构的基础知识。</p>
<p>该<a href="https://www.terraform.io/intro/getting-started/install.html" target="_blank" rel="noopener">官员Terraform入门文档</a>不会引入Terraform的各个要素（即资源，输入变量，输出变量等）的一个很好的工作，所以在本指南中，我们将重点放在如何把这些元素结合在一起创建一个相当现实的例子。特别是，我们将在集群中的AWS上配置多个服务器，并部署负载均衡器以在该集群中分配负载。您将在此示例中创建的基础结构是运行可扩展，高可用性Web服务和微服务的基本起点。</p>
<p>本指南面向AWS和Terraform新手，所以如果您以前没有使用过任何一个，请不要担心。我们将逐步指导您完成整个过程：</p>
<ol>
<li>设置您的AWS账户</li>
<li>安装Terraform</li>
<li>部署单个服务器</li>
<li>部署单个Web服务器</li>
<li>部署Web服务器集群</li>
<li>部署负载均衡器</li>
<li>清理</li>
</ol>
<p>您可以在以下<a href="https://github.com/gruntwork-io/intro-to-terraform" target="_blank" rel="noopener">网址</a>找到以下示例的完整示例代码：<a href="https://github.com/gruntwork-io/intro-to-terraform" target="_blank" rel="noopener">https</a>：<a href="https://github.com/gruntwork-io/intro-to-terraform" target="_blank" rel="noopener">//github.com/gruntwork-io/intro-to-terraform</a>。请注意，所有代码示例都是为Terraform 0.7.x编写的。</p>
<h3 id="设置您的AWS账户"><a href="#设置您的AWS账户" class="headerlink" title="设置您的AWS账户"></a>设置您的AWS账户</h3><p>Terraform可以为许多不同类型的云提供商提供基础架构，包括AWS，Azure，Google Cloud，DigitalOcean <a href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="noopener">等等</a>。在本教程中，我们选择了<a href="https://aws.amazon.com/" target="_blank" rel="noopener">Amazon Web Services（AWS），</a>因为：</p>
<ul>
<li>它提供了大量可靠且可扩展的云托管服务，包括<a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener">弹性计算云（EC2）</a>，<a href="https://aws.amazon.com/autoscaling/" target="_blank" rel="noopener">Auto Scaling组（ASG）</a>和<a href="https://aws.amazon.com/elasticloadbalancing/" target="_blank" rel="noopener">Elastic Load Balancing（ELB）</a>。如果您发现AWS术语令人困惑，请务必以<a href="https://www.expeditedssl.com/aws-in-plain-english" target="_blank" rel="noopener">简明英语</a>查看<a href="https://www.expeditedssl.com/aws-in-plain-english" target="_blank" rel="noopener">AWS</a>。</li>
<li>到目前为止，AWS是<a href="https://www.srgresearch.com/articles/aws-remains-dominant-despite-microsoft-and-google-growth-surges" target="_blank" rel="noopener">最受欢迎的云基础架构提供商</a>。</li>
<li>AWS提供了一个丰富的<a href="https://aws.amazon.com/free/" target="_blank" rel="noopener">免费套餐</a>，允许您<a href="https://aws.amazon.com/free/" target="_blank" rel="noopener">免费</a>运行所有这些示例。</li>
</ul>
<p>首次注册AWS时，您最初以<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html" target="_blank" rel="noopener">root用户</a>身份登录。此用户帐户具有对所有内容的访问权限，因此从安全角度来看，我们建议<em>仅</em>使用它来创建权限更有限的其他用户帐户（请参阅<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html" target="_blank" rel="noopener">IAM最佳实践</a>）。要创建更有限的用户帐户，请转到<a href="https://console.aws.amazon.com/iam/home?region=us-east-1#home" target="_blank" rel="noopener">身份和访问管理（IAM）控制台</a>，单击“用户”，然后单击蓝色的“创建新用户”按钮。输入用户的名称，并确保选中“为每个用户生成访问密钥”：</p>
<p><img src="/Terraform/Terraform简介/1.png" alt="img"></p>
<p>单击“创建”按钮，您将能够看到该用户的安全凭证，其中包括访问密钥ID和秘密访问密钥。你必须立即保存这些，因为它们永远不会再显示。我们建议将它们存储在安全的地方（例如密钥管理器，如Keychain或1Password），这样您可以在本教程中稍后使用它们。</p>
<p><img src="/Terraform/Terraform简介/2.png" alt="img"></p>
<p>将凭据保存在安全的地方。切勿与任何人分享。别担心，上面截图中的内容是假的。</p>
<p>保存凭据后，单击“关闭”（两次），您将进入用户列表。单击刚刚创建的用户，然后选择“权限”选项卡。默认情况下，新的IAM用户无权在AWS账户中执行任何操作。为了能够将Terraform用于本教程中的示例，请添加AmazonEC2FullAccess权限（<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-vs-inline.html" target="_blank" rel="noopener">在此处</a>了解有关<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-vs-inline.html" target="_blank" rel="noopener">托管IAM策略的</a>更多信息）：</p>
<p><img src="/Terraform/Terraform简介/3.png" alt="img"></p>
<h3 id="安装Terraform"><a href="#安装Terraform" class="headerlink" title="安装Terraform"></a>安装Terraform</h3><p>按照<a href="https://www.terraform.io/intro/getting-started/install.html" target="_blank" rel="noopener">此处</a>的<a href="https://www.terraform.io/intro/getting-started/install.html" target="_blank" rel="noopener">说明</a>安装Terraform。完成后，您应该能够运行terraform命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; terraform </span><br><span class="line">用法：terraform [--version] [ -  help] &lt;command&gt; [args]</span><br><span class="line">（......）</span><br></pre></td></tr></table></figure>
<p>为了使Terraform能够在您的AWS账户中进行更改，您需要为之前创建的用户设置AWS凭证作为环境变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">导出AWS_ACCESS_KEY_ID =（您的访问密钥ID）</span><br><span class="line">导出AWS_SECRET_ACCESS_KEY =（您的密钥访问密钥）</span><br></pre></td></tr></table></figure>
<h3 id="部署单个服务器"><a href="#部署单个服务器" class="headerlink" title="部署单个服务器"></a>部署单个服务器</h3><p>Terraform代码使用扩展名为“.tf”的文件中名为<a href="https://www.terraform.io/docs/configuration/syntax.html" target="_blank" rel="noopener">HCL</a>的语言编写。它是一种声明性语言，因此您的目标是描述您想要的基础架构，Terraform将弄清楚如何创建它。Terraform可以在各种平台上创建基础架构，或称为<a href="https://www.terraform.io/docs/providers/" target="_blank" rel="noopener">提供商</a>，包括AWS，Azure，Google Cloud，DigitalOcean和许多其他平台。使用Terraform的第一步通常是配置您要使用的提供程序。创建一个名为“main.tf”的文件并将以下代码放入其中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">提供者“aws”&#123; </span><br><span class="line">  region =“us-east-1” </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这告诉Terraform您将使用<a href="https://www.terraform.io/docs/providers/aws/" target="_blank" rel="noopener">AWS提供商</a>并希望在“us-east-1”区域部署您的基础架构（AWS在全球范围内拥有数据中心，分为<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" target="_blank" rel="noopener">区域和可用区域</a>，以及我们-east-1是美国弗吉尼亚州数据中心的名称。您可以为<a href="https://www.terraform.io/docs/providers/aws/index.html" target="_blank" rel="noopener">AWS提供程序</a>配置其他设置，但是对于此示例，由于您已将凭据配置为环境变量，因此您只需指定该区域。</p>
<p>对于每个提供程序，您可以创建许多不同类型的“资源”，例如服务器，数据库和负载平衡器。在我们部署整个服务器集群之前，让我们首先弄清楚如何部署一个运行简单“Hello，World”Web服务器的服务器。在AWS lingo中，服务器称为“EC2实例”。要部署EC2实例，请将以下代码添加到main.tf：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_instance”“example”&#123; </span><br><span class="line">  ami =“ami-2d39803a” </span><br><span class="line">  instance_type =“t2.micro” </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个资源指定一个类型（在本例中为“aws_instance”），一个名称（在本例中为“example”）用作Terraform代码中的标识符，以及一组特定于该资源的配置参数。该<a href="https://www.terraform.io/docs/providers/aws/r/instance.html" target="_blank" rel="noopener">aws_instance资源文件</a>列出了它所支持的所有参数。最初，您只需要设置以下内容：</p>
<ul>
<li><strong>ami</strong>：要在EC2实例上运行的<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html" target="_blank" rel="noopener">Amazon Machine Image</a>。上面的示例将此参数设置为us-east-1中<a href="https://aws.amazon.com/marketplace/pp/B00JV9TBA6?ref=cns_srchrow" target="_blank" rel="noopener">Ubuntu 14.04 AMI</a>的ID 。</li>
<li><strong>instance_type</strong>：要运行的EC2实例的类型。每个<a href="https://aws.amazon.com/ec2/instance-types/" target="_blank" rel="noopener">EC2实例类型</a>具有不同的CPU，内存，磁盘空间和网络规格。上面的示例使用“t2.micro”，它具有1个虚拟CPU，1GB内存，并且是AWS免费层的一部分。</li>
</ul>
<p>在终端中，进入创建main.tf的文件夹，然后运行“terraform plan”命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt; terraform计划</span><br><span class="line">在计划之前刷新Terraform内存状态...</span><br><span class="line">（......）</span><br><span class="line">+ aws_instance.example </span><br><span class="line">    ami：“ami-2d39803a” </span><br><span class="line">    availability_zone：“&lt;computed&gt;” </span><br><span class="line">    ebs_block_device。＃：“&lt;computed&gt;” </span><br><span class="line">    ephemeral_block_device。＃：“&lt;computed&gt;” </span><br><span class="line">    instance_state：“&lt;computed&gt;” </span><br><span class="line">    instance_type：“t2.micro” </span><br><span class="line">    key_name：“&lt;computed&gt;” </span><br><span class="line">    network_interface_id：“&lt;computed&gt;” </span><br><span class="line">    placement_group：“&lt;computed&gt;” </span><br><span class="line">    private_dns：“&lt;computed&gt;” </span><br><span class="line">    private_ip：“&lt;computed&gt;” </span><br><span class="line">    public_dns：“&lt;computed&gt;”</span><br><span class="line">    public_ip：“&lt;computed&gt;” </span><br><span class="line">    root_block_device。＃：“&lt;computed&gt;” </span><br><span class="line">    security_groups。＃：“&lt;computed&gt;”</span><br><span class="line">    source_dest_check：“true” </span><br><span class="line">    subnet_id：“&lt;computed&gt;” </span><br><span class="line">    租期：“&lt;computed&gt;” </span><br><span class="line">    vpc_security_group_ids。＃：“&lt;计算&gt;”</span><br><span class="line">计划：1添加，0改变，0破坏。</span><br></pre></td></tr></table></figure>
<p>plan命令可让您在实际执行之前查看Terraform将执行的操作。这是一种很好的方法，可以在将更改释放到世界之前检查您的更改。plan命令的输出有点像diff命令的输出：将创建带有加号（+）的资源，带有减号（ - ）的资源将被删除，带有波浪号的资源将被删除符号（〜）将被修改。在上面的输出中，您可以看到Terraform正计划创建单个EC2实例，而不是其他任何内容，这正是我们想要的。</p>
<p>要实际创建实例，请运行“terraform apply”命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt; terraform apply </span><br><span class="line">aws_instance.example：Creating ... </span><br><span class="line">  ami：“”=&gt;“ami-2d39803a” </span><br><span class="line">  availability_zone：“”=&gt;“&lt;computed&gt;” </span><br><span class="line">  ebs_block_device。＃：“”=&gt;“&lt;computed&gt;” </span><br><span class="line">  ephemeral_block_device。＃： “”=&gt;“&lt;计算&gt;”“ </span><br><span class="line">  instance_state：”“=&gt;”&lt;计算&gt;“ </span><br><span class="line">  instance_type：”“=&gt;”t2.micro“ </span><br><span class="line">  key_name：”“=&gt;”&lt;计算&gt;“ </span><br><span class="line">  network_interface_id：”“=&gt;”&lt; computed&gt;“ </span><br><span class="line">  placement_group：”“=&gt;”&lt;computed&gt;“ </span><br><span class="line">  private_dns：“”=&gt;“&lt;计算&gt;” </span><br><span class="line">  private_ip：“”=&gt;“&lt;计算&gt;”“ </span><br><span class="line">  public_dns：”“=&gt;”&lt;计算&gt;“ </span><br><span class="line">  public_ip：”“=&gt;”&lt;计算&gt;“</span><br><span class="line">  root_block_device。＃：“”=&gt;“&lt;计算&gt;”“ </span><br><span class="line">  security_groups。＃：”“=&gt;”&lt;计算&gt;“ </span><br><span class="line">  source_dest_check：”“=&gt;”true“ </span><br><span class="line">  subnet_id：”“=&gt;”&lt;计算&gt;“ </span><br><span class="line">  租期：”“ &gt;&gt; &lt;计算&gt;“ </span><br><span class="line">  vpc_security_group_ids。＃：”“=&gt;”&lt;计算&gt;“ </span><br><span class="line">aws_instance.example：仍在创建...（已过去10秒）</span><br><span class="line">aws_instance.example：仍在创建...（已过20秒）</span><br><span class="line">aws_instance.example：创作完成</span><br><span class="line">申请完成！资源：1添加，0更改，0销毁。</span><br></pre></td></tr></table></figure>
<p>恭喜，您刚刚部署了Terraform服务器！要验证这一点，您可以登录<a href="https://console.aws.amazon.com/ec2/v2/home" target="_blank" rel="noopener">EC2控制台</a>，您将看到如下内容：</p>
<p><img src="/Terraform/Terraform简介/4.png" alt="img"></p>
<p>这是有效的，但这不是最激动人心的例子。首先，Instance没有名称。要添加一个，您可以向EC2实例添加<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html" target="_blank" rel="noopener">标记</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_instance”“example”&#123; </span><br><span class="line">  ami =“ami-2d39803a” </span><br><span class="line">  instance_type =“t2.micro”</span><br><span class="line">  标签&#123; </span><br><span class="line">    Name =“terraform-example” </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次运行计划命令以查看这将执行的操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; terraform计划</span><br><span class="line">aws_instance.example：刷新状态...（ID：i-6a7c545b）</span><br><span class="line">（......）</span><br><span class="line">~aws_instance.example </span><br><span class="line">    tags。％：“0”=&gt;“1” </span><br><span class="line">    tags.Name：“”=&gt;“terraform-example”</span><br><span class="line">计划：0添加，1更改，0销毁。</span><br></pre></td></tr></table></figure>
<p>Terraform会跟踪它为这组模板创建的所有资源，因此它知道您的EC2实例已经存在（注意Terraform在运行计划命令时如何说“刷新状态…”），它可以显示两者之间的差异当前部署的内容以及Terraform代码中的内容（这是使用<a href="https://blog.gruntwork.io/why-we-use-terraform-and-not-chef-puppet-ansible-saltstack-or-cloudformation-7989dad2865c#.z5vvdu1q9" target="_blank" rel="noopener">声明性语言而不是程序性语言</a>的优势<a href="https://blog.gruntwork.io/why-we-use-terraform-and-not-chef-puppet-ansible-saltstack-or-cloudformation-7989dad2865c#.z5vvdu1q9" target="_blank" rel="noopener">之一</a>）。上面的差异显示Terraform想要创建一个名为“Name”的单个标签，这正是我们想要的，所以你应该再次运行“apply”命令。刷新EC2控制台时，您会看到：</p>
<p><img src="/Terraform/Terraform简介/5.png" alt="img"></p>
<h3 id="部署单个Web服务器"><a href="#部署单个Web服务器" class="headerlink" title="部署单个Web服务器"></a>部署单个Web服务器</h3><p>下一步是在此实例上运行Web服务器。在一个真实的用例中，您可能会安装一个功能齐全的Web框架，如Ruby on Rails或Django，但为了保持这个简单的示例，我们将运行一个简单的Web服务器，它始终返回文本“Hello，World”使用从<a href="https://gist.github.com/willurd/5720255" target="_blank" rel="noopener">http静态服务器单行列表中</a>借来的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">＃！/ bin / bash </span><br><span class="line">echo“Hello，World”&gt; index.html </span><br><span class="line">nohup busybox httpd -f -p 8080＆</span><br></pre></td></tr></table></figure>
<p>这是一个bash脚本，它将文本“Hello，World”写入index.html，并使用<a href="https://busybox.net/" target="_blank" rel="noopener">busybox</a>（在Ubuntu上默认安装）在端口8080上运行Web服务器，以便在URL“/”处提供该文件。我们使用<a href="https://en.wikipedia.org/wiki/Nohup" target="_blank" rel="noopener">nohup</a>包装busybox命令，以确保即使在此脚本退出后Web服务器仍在运行，并在命令末尾添加“＆”，以便Web服务器在后台进程中运行，因此脚本实际上可以退出而不是被阻止永远是由Web服务器。</p>
<p>如何让EC2实例运行此脚本？通常，您可以使用像<a href="https://www.packer.io/" target="_blank" rel="noopener">Packer</a>这样的工具来创建安装了Web服务器的自定义AMI ，而不是使用空的Ubuntu AMI 。但同样，为了保持这个例子的简单，我们将上面的脚本作为EC2 Instance的<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html" target="_blank" rel="noopener">用户数据的</a>一部分运行，AWS将在实例启动时执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_instance”“example”&#123; </span><br><span class="line">  ami =“ami-2d39803a” </span><br><span class="line">  instance_type =“t2.micro” </span><br><span class="line">  </span><br><span class="line">  user_data = &lt;&lt;  -  EOF </span><br><span class="line">              ＃！/ bin / bash </span><br><span class="line">              echo“Hello，World”&gt; index.html </span><br><span class="line">              nohup busybox httpd -f  - p 8080＆</span><br><span class="line">              EOF</span><br><span class="line">  标签&#123; </span><br><span class="line">    Name =“terraform-example” </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>“&lt;&lt; - EOF”和“EOF”是Terraform的heredoc语法，它允许您创建多行字符串而无需将“\ n”放在所有位置（<a href="https://www.terraform.io/docs/configuration/syntax.html" target="_blank" rel="noopener">在此处</a>了解有关<a href="https://www.terraform.io/docs/configuration/syntax.html" target="_blank" rel="noopener">Terraform语法的</a>更多信息）。</p>
<p>在此Web服务器工作之前，您需要再做一件事。默认情况下，AWS不允许来自EC2实例的任何传入或传出流量。要允许EC2实例在端口8080上接收流量，您需要创建一个<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html" target="_blank" rel="noopener">安全组</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_security_group”“instance”&#123; </span><br><span class="line">  name =“terraform-example-instance”</span><br><span class="line">  ingress &#123; </span><br><span class="line">    from_port = 8080 </span><br><span class="line">    to_port = 8080 </span><br><span class="line">    protocol =“tcp” </span><br><span class="line">    cidr_blocks = [“0.0.0.0/0”] </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码创建了一个名为<a href="https://www.terraform.io/docs/providers/aws/r/security_group.html" target="_blank" rel="noopener">aws_security_group</a>的新资源（注意AWS提供程序的所有资源如何以“aws_”开头）并指定该组允许来自CIDR块0.0.0.0/0的端口8080上的传入TCP请求。<a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="_blank" rel="noopener">CIDR块</a>是指定IP地址范围的简明方法。例如，10.0.0.0/24的CIDR块表示10.0.0.0和10.0.0.255之间的所有IP地址。CIDR块0.0.0.0/0是包含所有可能IP地址的IP地址范围，因此上面的安全组允许来自任何IP的端口8080上的传入请求。</p>
<p>请注意，在上面的安全组中，我们复制并粘贴了端口8080.为了使代码保持<a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="noopener">干燥</a>并使配置代码变得容易，Terraform允许您定义<a href="https://www.terraform.io/intro/getting-started/variables.html" target="_blank" rel="noopener">输入变量</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">变量“server_port”&#123; </span><br><span class="line">  description =“服务器将用于HTTP请求的端口” </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>您可以通过Terraform的<a href="https://www.terraform.io/docs/configuration/interpolation.html" target="_blank" rel="noopener">插值语法</a>在安全组中使用此变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from_port =“$ &#123;var.server_port&#125;” </span><br><span class="line">to_port =“$ &#123;var.server_port&#125;”</span><br></pre></td></tr></table></figure>
<p>您还可以在EC2实例的user_data中使用相同的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup busybox httpd -f -p“$ &#123;var.server_port&#125;”＆</span><br></pre></td></tr></table></figure>
<p>如果您现在运行计划或应用命令，Terraform将提示您输入server_port变量的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; terraform plan </span><br><span class="line">var.server_port </span><br><span class="line">  服务器将用于HTTP请求的端口</span><br><span class="line">输入值：8080</span><br></pre></td></tr></table></figure>
<p>为变量提供值的另一种方法是使用“-var”命令行选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; terraform plan -var server_port =“8080”</span><br></pre></td></tr></table></figure>
<p>如果您不希望每次都手动输入端口，则可以将默认值指定为变量声明的一部分（请注意，仍可通过“-var”命令行选项覆盖此默认值）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">变量“server_port”&#123; </span><br><span class="line">  description =“服务器将用于HTTP请求的端口” </span><br><span class="line">  default = 8080 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后要做的事情是：您需要告诉EC2实例实际使用新的安全组。为此，您需要将安全组的ID传递到aws_instance资源的vpc_security_group_ids参数中。你怎么得到这个ID？</p>
<p>在Terraform中，每个资源都具有可以使用与插值相同的语法引用的属性。您可以在每个资源的文档中找到属性列表。例如，<a href="https://www.terraform.io/docs/providers/aws/r/security_group.html#attributes-reference" target="_blank" rel="noopener">aws_security_group属性</a>包括安全组的ID，您可以在EC2实例中引用该ID，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vpc_security_group_ids = [“$ &#123;aws_security_group.instance.id&#125;”]</span><br></pre></td></tr></table></figure>
<p>语法为“$ {TYPE.NAME.ATTRIBUTE}”。当一个资源引用另一个资源时，您将创建一个<a href="https://www.terraform.io/intro/getting-started/dependencies.html" target="_blank" rel="noopener">隐式依赖项</a>。Terraform解析这些依赖关系，从它们构建依赖关系图，并使用它来自动确定它应该以什么顺序创建资源（例如Terraform知道它需要在将其与EC2实例一起使用之前创建安全组）。实际上，Terraform将尽可能并行地创建尽可能多的资源，这意味着它可以非常快速地应用您的更改。这就是声明性语言的美妙之处：你只需指定你想要的东西，Terraform就会找出实现它的最有效方法。</p>
<p>如果运行计划命令，您将看到Terraform想要用具有新用户数据的新EC2实例（“ - / +”表示“替换”）替换原始EC2实例并添加安全组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; terraform计划</span><br><span class="line">（......）</span><br><span class="line">-  / + aws_instance.example </span><br><span class="line">    ami：“ami-2d39803a”=&gt;“ami-2d39803a” </span><br><span class="line">    instance_state：“running”=&gt;“&lt;computed&gt;” </span><br><span class="line">    instance_type：“t2.micro”=&gt;“t2.micro” </span><br><span class="line">    security_groups。＃： “0”=&gt;“&lt;计算&gt;” </span><br><span class="line">    vpc_security_group_ids。＃：“1”=&gt;“&lt;计算&gt;”</span><br><span class="line">（......）</span><br><span class="line">+ aws_security_group.instance </span><br><span class="line">    描述：“由Terraform管理” </span><br><span class="line">    出口。＃：“&lt;计算&gt;” </span><br><span class="line">    入口。＃：“1” </span><br><span class="line">    ingress.516175195.cidr_blocks。＃：“1” </span><br><span class="line">    ingress.516175195.cidr_blocks.0：“0.0.0.0 / 0“ </span><br><span class="line">    ingress.516175195.from_port：”8080“ </span><br><span class="line">    ingress.516175195.protocol：”tcp“ </span><br><span class="line">    ingress.516175195.security_groups。＃：”0“ </span><br><span class="line">    ingress.516175195.self：”false“ </span><br><span class="line">    ingress.516175195.to_port：”8080“ </span><br><span class="line">    owner_id：“&lt;计算&gt;” </span><br><span class="line">    vpc_id：“&lt;计算&gt;”</span><br><span class="line">计划：2添加，0改变，1破坏。</span><br></pre></td></tr></table></figure>
<p>这正是我们想要的，所以再次运行apply命令，您将看到新的EC2实例部署：</p>
<p><img src="/Terraform/Terraform简介/6.png" alt="img"></p>
<p>在屏幕底部的描述面板中，您还将看到此EC2实例的公共IP地址。给它一两分钟启动，然后尝试在端口8080处卷曲此IP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl http：// &lt;EC2_INSTANCE_PUBLIC_IP&gt;：8080 </span><br><span class="line">Hello，World</span><br></pre></td></tr></table></figure>
<p>耶，一个工作的网络服务器！但是，必须手动在EC2控制台周围找到这个IP地址并不好玩。幸运的是，您可以通过指定<a href="https://www.terraform.io/intro/getting-started/outputs.html" target="_blank" rel="noopener">输出变量</a>来做得更好：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输出“public_ip”&#123; </span><br><span class="line">  value =“ $ &#123;aws_instance.example.public_ip &#125;” </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们再次使用插值语法来引用aws_instance资源的public_ip属性。如果再次运行apply命令，Terraform将不会应用任何更改（因为您没有更改任何资源），但它会显示新输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; terraform apply </span><br><span class="line">aws_security_group.instance：刷新状态...（ID：sg-db91dba1）</span><br><span class="line">aws_instance.example：刷新状态...（ID：i-61744350）</span><br><span class="line">申请完成！资源：0添加，0更改，0销毁。</span><br><span class="line">输出：</span><br><span class="line">public_ip = 54.174.13.5</span><br></pre></td></tr></table></figure>
<p>输入和输出变量是Terraform强大功能的重要组成部分，特别是与模块结合使用时，我们将在第4部分中讨论的主题，<a href="https://blog.gruntwork.io/how-to-create-reusable-infrastructure-with-terraform-modules-25526d65f73d" target="_blank" rel="noopener">如何使用Terraform模块创建可重用的基础架构</a>。</p>
<h3 id="部署Web服务器集群"><a href="#部署Web服务器集群" class="headerlink" title="部署Web服务器集群"></a>部署Web服务器集群</h3><p>运行单个服务器是一个良好的开端，但在现实世界中，单个服务器是单点故障。如果该服务器崩溃，或者由于流量太大而导致服务器不堪重负，则用户将无法再访问您的站点。解决方案是运行服务器群集，绕过服务器路由，并根据流量调整群集大小（有关详细信息，请查看<a href="https://www.airpair.com/aws/posts/building-a-scalable-web-app-on-amazon-web-services-p1" target="_blank" rel="noopener">在Amazon Web Services上构建可扩展Web应用程序的综合指南</a>）。</p>
<p>手动管理这样的集群是很多工作。幸运的是，您可以让AWS使用<a href="https://aws.amazon.com/autoscaling/" target="_blank" rel="noopener">Auto Scaling Group（ASG）来处理它</a>。ASG可以自动启动EC2实例集群，监控其运行状况，自动重启故障节点，并根据需求调整集群大小。</p>
<p>创建ASG的第一步是创建<a href="http://docs.aws.amazon.com/autoscaling/latest/userguide/LaunchConfiguration.html" target="_blank" rel="noopener">启动配置</a>，该<a href="http://docs.aws.amazon.com/autoscaling/latest/userguide/LaunchConfiguration.html" target="_blank" rel="noopener">配置</a>指定如何在ASG中配置每个EC2实例。从早期部署单个EC2实例开始，您已经确切地知道如何配置它，并且您可以在<a href="https://www.terraform.io/docs/providers/aws/r/launch_configuration.html" target="_blank" rel="noopener">aws_launch_configuration</a>资源中重用几乎完全相同的参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_launch_configuration”“example”&#123; </span><br><span class="line">  image_id =“ami-2d39803a” </span><br><span class="line">  instance_type =“t2.micro” </span><br><span class="line">  security_groups = [“$ &#123;aws_security_group.instance.id&#125;”]</span><br><span class="line">  user_data = &lt;&lt;  -  EOF </span><br><span class="line">              ＃！/ bin / bash </span><br><span class="line">              echo“Hello，World”&gt; index.html </span><br><span class="line">              nohup busybox httpd -f -p“$ &#123;var.server_port&#125;”＆</span><br><span class="line">              EOF</span><br><span class="line">  生命周期&#123; </span><br><span class="line">    create_before_destroy = true </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>唯一新添加的是生命周期块，这是使用ASG启动配置所必需的。您可以向任何Terraform资源添加<a href="https://www.terraform.io/docs/configuration/resources.html#lifecycle" target="_blank" rel="noopener">生命周期块</a>以自定义其生命周期行为。其中一个可用的生命周期设置是create_before_destroy，它告诉Terraform在销毁原始文件之前始终创建替换资源（例如，在替换EC2实例时，始终在删除旧实例之前创建新实例）。</p>
<p>create_before_destroy参数的捕获是，如果在资源X上将其设置为true，则还必须在X依赖的每个资源上将其设置为true。对于启动配置，这意味着您需要在安全组上将create_before_destroy设置为true：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_security_group”“instance”&#123; </span><br><span class="line">  name =“terraform-example-instance”</span><br><span class="line">  ingress &#123; </span><br><span class="line">    from_port =“$ &#123;var.server_port&#125;” </span><br><span class="line">    to_port =“$ &#123;var.server_port&#125;” </span><br><span class="line">    protocol =“tcp” </span><br><span class="line">    cidr_blocks = [“0.0.0.0/0”] </span><br><span class="line">  &#125;</span><br><span class="line">  生命周期&#123; </span><br><span class="line">    create_before_destroy = true </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，您可以使用<a href="https://www.terraform.io/docs/providers/aws/r/autoscaling_group.html" target="_blank" rel="noopener">aws_autoscaling_group资源</a>创建ASG ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_autoscaling_group”“example”&#123; </span><br><span class="line">  launch_configuration =“$ &#123;aws_launch_configuration.example.id&#125;”</span><br><span class="line">  min_size = 2 </span><br><span class="line">  max_size = 10</span><br><span class="line">  tag &#123; </span><br><span class="line">    key =“Name” </span><br><span class="line">    value =“terraform-asg-example” </span><br><span class="line">    propagate_at_launch = true </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此ASG将运行2到10个EC2实例（初始启动默认为2），每个实例都标记为“terraform-example”。每个EC2实例的配置由您之前创建的启动配置决定，我们使用Terraform的插值语法进行参考。</p>
<p>要使此ASG正常工作，您需要再指定一个参数：availability_zones。此参数指定应部署EC2实例的<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" target="_blank" rel="noopener">可用区</a>（AZ）。每个AZ代表一个独立的AWS数据中心，因此通过跨多个AZ部署实例，即使某些AZ发生故障，也可确保您的服务可以继续运行。您可以对AZ列表进行硬编码（例如将其设置为[“us-east-1a”，“us-east-1b”]），但每个AWS账户都可以访问一组略有不同的AZ，因此您可以使用<a href="https://www.terraform.io/docs/providers/aws/d/availability_zones.html" target="_blank" rel="noopener">aws_availability_zones数据源</a>获取您帐户的确切列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">数据“aws_availability_zones”“全部”&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>甲<a href="https://www.terraform.io/docs/configuration/data-sources.html" target="_blank" rel="noopener">数据源</a>表示一块的只读信息被取出从提供者（在此情况下，AWS）每次运行Terraform时间。除可用区域外，还有数据源可查找<a href="https://www.terraform.io/docs/providers/aws/d/ami.html" target="_blank" rel="noopener">AMI ID</a>，<a href="https://www.terraform.io/docs/providers/aws/d/ip_ranges.html" target="_blank" rel="noopener">IP地址范围</a>和<a href="https://www.terraform.io/docs/providers/aws/d/caller_identity.html" target="_blank" rel="noopener">当前用户的身份</a>。将数据源添加到Terraform模板不会创建任何新内容; 它只是一种检索动态数据的方法。</p>
<p>要使用数据源，请使用标准插值语法引用它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_autoscaling_group”“example”&#123; </span><br><span class="line">  launch_configuration =“$ &#123;aws_launch_configuration.example.id&#125;” </span><br><span class="line">  availability_zones = [“$ &#123;data.aws_availability_zones.all.names&#125;”]</span><br><span class="line">  min_size = 2 </span><br><span class="line">  max_size = 10</span><br><span class="line">  tag &#123; </span><br><span class="line">    key =“Name” </span><br><span class="line">    value =“terraform-asg-example” </span><br><span class="line">    propagate_at_launch = true </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="部署负载均衡器"><a href="#部署负载均衡器" class="headerlink" title="部署负载均衡器"></a>部署负载均衡器</h3><p>在启动ASG之前，还有一个问题需要解决：现在您有许多实例，您需要一个负载均衡器来分配所有实例的流量。创建高可用性和可伸缩性的负载均衡器需要大量工作。您可以再次使用<a href="https://aws.amazon.com/elasticloadbalancing/" target="_blank" rel="noopener">Elastic Load Balancer（ELB）</a>让AWS为您处理。要使用Terraform创建ELB，请使用<a href="https://www.terraform.io/docs/providers/aws/r/elb.html" target="_blank" rel="noopener">aws_elb资源</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_elb”“example”&#123; </span><br><span class="line">  name =“terraform-asg-example” </span><br><span class="line">  availability_zones = [“$ &#123;data.aws_availability_zones.all.names&#125;”] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这会创建一个ELB，可以在您帐户中的所有AZ中使用。当然，在你告诉ELB如何路由请求之前，上面的定义并不多。为此，您添加一个或多个“侦听器”，指定ELB应侦听的端口以及应将请求路由到的端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_elb”“example”&#123; </span><br><span class="line">  name =“terraform-asg-example” </span><br><span class="line">  availability_zones = [“$ &#123;data.aws_availability_zones.all.names&#125;”]</span><br><span class="line">  listener &#123; </span><br><span class="line">    lb_port = 80 </span><br><span class="line">    lb_protocol =“http” </span><br><span class="line">    instance_port =“$ &#123;var.server_port&#125;” </span><br><span class="line">    instance_protocol =“http” </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的代码中，我们告诉ELB在端口80（HTTP的默认端口）上接收HTTP请求，并将它们路由到ASG中Instances使用的端口。请注意，默认情况下，ELB不允许任何传入或传出流量（就像EC2实例一样），因此您需要添加一个安全组以明确允许端口80上的传入请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_security_group”“elb”&#123; </span><br><span class="line">  name =“terraform-example-elb”</span><br><span class="line">  ingress &#123; </span><br><span class="line">    from_port = 80 </span><br><span class="line">    to_port = 80 </span><br><span class="line">    protocol =“tcp” </span><br><span class="line">    cidr_blocks = [“0.0.0.0/0”] </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，您需要通过添加security_groups参数告诉ELB使用此安全组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_elb”“example”&#123; </span><br><span class="line">  name =“terraform-asg-example” </span><br><span class="line">  security_groups = [“$ &#123;aws_security_group.elb.id&#125;”] </span><br><span class="line">  availability_zones = [“$ &#123;data.aws_availability_zones.all.names&#125;”]</span><br><span class="line">  listener &#123; </span><br><span class="line">    lb_port = 80 </span><br><span class="line">    lb_protocol =“http” </span><br><span class="line">    instance_port =“$ &#123;var.server_port&#125;” </span><br><span class="line">    instance_protocol =“http” </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ELB还有另外一个漂亮的技巧：它可以定期检查你的EC2实例的运行状况，如果一个实例不健康，它会自动停止将流量路由到它。让我们添加一个HTTP运行状况检查，其中ELB将每隔30秒向每个EC2实例的“/”URL发送一个HTTP请求，并且只有在实例响应200 OK时才将其标记为正常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_elb”“example”&#123; </span><br><span class="line">  name =“terraform-asg-example” </span><br><span class="line">  security_groups = [“$ &#123;aws_security_group.elb.id&#125;”] </span><br><span class="line">  availability_zones = [“$ &#123;data.aws_availability_zones.all.names&#125;”]</span><br><span class="line">  health_check &#123; </span><br><span class="line">    healthy_threshold = 2 </span><br><span class="line">    unhealthy_threshold = 2 </span><br><span class="line">    timeout = 3 </span><br><span class="line">    interval = 30 </span><br><span class="line">    target =“HTTP：$ &#123;var.server_port&#125; /” </span><br><span class="line">  &#125;</span><br><span class="line">  listener &#123; </span><br><span class="line">    lb_port = 80 </span><br><span class="line">    lb_protocol =“http” </span><br><span class="line">    instance_port =“$ &#123;var.server_port&#125;” </span><br><span class="line">    instance_protocol =“http” </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要允许这些运行状况检查请求，您需要修改ELB的安全组以允许出站请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_security_group”“elb”&#123; </span><br><span class="line">  name =“terraform-example-elb”</span><br><span class="line">  出口&#123; </span><br><span class="line">    from_port = 0 </span><br><span class="line">    to_port = 0 </span><br><span class="line">    protocol =“ -  1” </span><br><span class="line">    cidr_blocks = [“0.0.0.0/0”] </span><br><span class="line">  &#125;</span><br><span class="line">  ingress &#123; </span><br><span class="line">    from_port = 80 </span><br><span class="line">    to_port = 80 </span><br><span class="line">    protocol =“tcp” </span><br><span class="line">    cidr_blocks = [“0.0.0.0/0”] </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ELB如何知道向哪些EC2实例发送请求？您可以使用ELB的实例参数将EC2实例的静态列表附加到ELB，但是使用ASG，实例将一直动态启动和终止，因此无法工作。相反，您可以使用aws_autoscaling_group资源的load_balancers参数告诉ASG在该实例启动时注册ELB中的每个实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">资源“aws_autoscaling_group”“example”&#123; </span><br><span class="line">  launch_configuration =“$ &#123;aws_launch_configuration.example.id&#125;” </span><br><span class="line">  availability_zones = [“$ &#123;data.aws_availability_zones.all.names&#125;”]</span><br><span class="line">  min_size = 2 </span><br><span class="line">  max_size = 10</span><br><span class="line">  load_balancers = [“$ &#123;aws_elb.example.name&#125;”] </span><br><span class="line">  health_check_type =“ELB”</span><br><span class="line">  tag &#123; </span><br><span class="line">    key =“Name” </span><br><span class="line">    value =“terraform-asg-example” </span><br><span class="line">    propagate_at_launch = true </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请注意，我们还将ASG的health_check_type配置为“ELB”。这告诉ASG使用ELB的运行状况检查来确定实例是否健康，并在ELB将其报告为不健康时自动重启实例。</p>
<p>在部署负载均衡器之前要做的最后一件事：让我们将其DNS名称添加为输出，以便更容易测试事情是否正常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输出“elb_dns_name”&#123; </span><br><span class="line">  value =“$ &#123;aws_elb.example.dns_name&#125;” </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行plan命令以验证您的更改，如果一切正常，请运行apply。应用完成后，您应该看到elb_dns_name输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输出：</span><br><span class="line">elb_dns_name = terraform-asg-example-123.us-east-1.elb.amazonaws.com</span><br></pre></td></tr></table></figure>
<p>复制此URL。实例启动并在ELB中显示为健康状态需要几分钟。在此期间，您可以检查已部署的内容。打开<a href="https://console.aws.amazon.com/ec2/autoscaling/home" target="_blank" rel="noopener">EC2控制台</a>的<a href="https://console.aws.amazon.com/ec2/autoscaling/home" target="_blank" rel="noopener">ASG部分</a>，您应该看到已创建ASG：</p>
<p><img src="/Terraform/Terraform简介/7.png" alt="img"></p>
<p>如果切换到Instances选项卡，您将在启动过程中看到两个实例：</p>
<p><img src="/Terraform/Terraform简介/8.png" alt="img"></p>
<p>最后，如果切换到Load Balancers选项卡，您将看到您的ELB：</p>
<p><img src="/Terraform/Terraform简介/9.png" alt="img"></p>
<p>等待“状态”指示符说“服务中有2个实例中的2个”。这通常需要1-2分钟。看到之后，测试先前复制的elb_dns_name输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl http：// &lt;elb_dns_name&gt; </span><br><span class="line">Hello，World</span><br></pre></td></tr></table></figure>
<p>成功！ELB将流量路由到您的EC2实例。每次点击URL时，它都会选择不同的实例来处理请求。您现在拥有一个完全可用的Web服务器集群！提醒一下，上面示例的完整示例代码位于：<a href="https://github.com/gruntwork-io/intro-to-terraform" target="_blank" rel="noopener">https</a>：<a href="https://github.com/gruntwork-io/intro-to-terraform" target="_blank" rel="noopener">//github.com/gruntwork-io/intro-to-terraform</a>。</p>
<p>此时，您可以看到群集如何响应启动新实例或关闭旧实例。例如，转到Instances选项卡，通过选中其复选框，选择顶部的“Actions”按钮，然后将“Instance State”设置为“Terminate”来终止其中一个Instances。继续测试ELB URL和你即使在终止实例时，也应该为每个请求获得“200 OK”，因为ELB将自动检测到Instance已关闭并停止路由到它。更有趣的是，在实例关闭后的短时间内，ASG将检测到正在运行的实例少于2个，并自动启动一个新实例来替换它（自我修复！）。您还可以通过更改min_size和max_size参数或向Terraform代码添加desired_size参数来查看ASG如何调整自身大小。</p>
<p>当然，ASG还有许多其他方面，我们在这里没有涉及。对于实际部署，您需要将IAM角色附加到EC2实例，设置机制以使用零停机时间更新ASG中的EC2实例，并配置自动扩展策略以调整ASG的大小以响应负载。对于完全预组装，经过实战考验，文档化，生产就绪的ASG版本，以及其他类型的基础架构（如Docker集群，关系数据库，VPC等），您可能需要查看<a href="https://blog.gruntwork.io/gruntwork-infrastructure-packages-7434dc77d0b1#.luxpdx7n6" target="_blank" rel="noopener">Gruntwork基础架构包裹</a>。</p>
<h3 id="清理"><a href="#清理" class="headerlink" title="清理"></a>清理</h3><p>当您尝试使用Terraform时，最好删除您创建的所有资源，以便AWS不会向您收取费用。由于Terraform会跟踪您创建的资源，因此清理工作变得轻而易举。您需要做的就是运行destroy命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform destroy </span><br><span class="line">你真的想破坏吗？</span><br><span class="line">  Terraform将删除您的所有托管基础架构。</span><br><span class="line">  没有撤消。只接受&apos;是&apos;确认。</span><br><span class="line">输入一个值：</span><br></pre></td></tr></table></figure>
<p>输入“yes”并按Enter键后，Terraform将使用尽可能多的并行性构建依赖关系图并按正确的顺序删除所有资源。大约一分钟后，您的AWS账户应该再次清理。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>您现在已经掌握了如何使用Terraform的基本知识。声明性语言可以很容易地准确描述您要创建的基础结构。plan命令允许您在部署之前验证更改并捕获错误。变量，插值和依赖性允许您保持代码干燥和高效。</p>
<p>但是，我们只是触及了表面。在本系列的第3部分“ <a href="https://blog.gruntwork.io/how-to-manage-terraform-state-28f5697e68fa" target="_blank" rel="noopener">如何管理Terraform状态”中</a>，我们将展示Terraform如何跟踪它已经创建的基础架构，以及对如何构建Terraform代码所产生的深远影响。在本系列的第4部分中，我们将展示<a href="https://blog.gruntwork.io/how-to-create-reusable-infrastructure-with-terraform-modules-25526d65f73d" target="_blank" rel="noopener">如何使用Terraform模块创建可重用的基础架构</a>。</p>

    </div>
    
        <div class="reward" ontouchstart="">
    <div class="reward-wrap">赏
        <div class="reward-box">
            
            
                <span class="reward-type">
                    <img class="wechat" src="/img/wechatpay.jpg"><b>微信打赏</b>
                </span>
            
        </div>
    </div>
    <p class="reward-tip">坚持原创分享，您的支持将鼓励我继续创作！</p>
</div>


    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">Mark</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/Jenkins/主流CI-CD工具比较：Jenkins-vs-Bamboo-vsTeamcity/" class="pre-post btn btn-default" title="主流CI/CD工具比较：Jenkins vs Bamboo vs Teamcity">
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">主流CI/CD工具比较：Jenkins vs Bamboo vs Teamcity</span>
        </a>
    
    
        <a href="/Docker/Docker-Swarm架构、特性与基本实践/" class="next-post btn btn-default" title="Docker Swarm架构、特性与基本实践">
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">Docker Swarm架构、特性与基本实践</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: 'undefined',
            appKey: 'undefined',
            placeholder: '说点什么吧',
            notify: false,
            verify: false,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'null'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">Table of Contents</h3>
        
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#设置您的AWS账户"><span class="toc-text">设置您的AWS账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Terraform"><span class="toc-text">安装Terraform</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署单个服务器"><span class="toc-text">部署单个服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署单个Web服务器"><span class="toc-text">部署单个Web服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署Web服务器集群"><span class="toc-text">部署Web服务器集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署负载均衡器"><span class="toc-text">部署负载均衡器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#清理"><span class="toc-text">清理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结论"><span class="toc-text">结论</span></a></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2017
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>